// //app/account-management/page.tsx
// "use client";

// import * as React from "react";
// import { useEffect, useState } from "react";
// import { supabase } from '@/utils/supabase/client';
// import { DashboardLayout } from "@/components/layout/dashboard-layout";
// import { Button } from "@/components/ui/button";
// import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
// import { Badge } from "@/components/ui/badge";
// import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
// import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
// import { Input } from "@/components/ui/input";
// import { Label } from "@/components/ui/label";
// import { Textarea } from "@/components/ui/textarea";
// import { Eye, MessageSquare, Star, Calendar } from "lucide-react";
// import ProtectedRoute from "@/components/auth/ProtectedRoute";
// import Papa from "papaparse";
// import { useContext } from "react";
// import { LoadingContext } from "@/components/providers/LoadingContext";
// import FullScreenLoader from "@/components/ui/FullScreenLoader";

// type AccountStage = "DNP" | "Call Again" | "Conversation Done";

// interface FollowUp {
//   date: string;
//   notes: string;
// }

// interface Feedback {
//   isHappy: boolean;
//   rating: number;
//   notes: string;
//   willRenew: boolean;
//   date: string;
// }

// interface Client {
//   id: string;
//   client_name: string;
//   email: string;
//   phone?: string;
//   assigned_to: string;
//   stage: AccountStage;
//   created_at: string;
//   follow_ups?: FollowUp[];
//   feedback?: Feedback;
// }

// const accountStages: AccountStage[] = ["DNP", "Call Again", "Conversation Done"];

// const getStageColor = (stage: AccountStage) => {
//   switch (stage) {
//     case "DNP":
//       return "bg-yellow-100 text-yellow-800";
//     case "Call Again":
//       return "bg-blue-100 text-blue-800";
//     case "Conversation Done":
//       return "bg-green-100 text-green-800";
//     default:
//       return "bg-gray-100 text-gray-800";
//   }
// };

// const formatDate = (dateString: string | undefined): string => {
//   if (!dateString) return "N/A";
//   try {
//     const date = new Date(dateString);
//     if (isNaN(date.getTime())) return "N/A";
//     return date.toLocaleDateString();
//   } catch (error) {
//     console.error("Error parsing date:", dateString, error);
//     return "N/A";
//   }
// };

// function renderStars(rating: number) {
//   return (
//     <span className="flex">
//       {Array.from({ length: 5 }, (_, i) => (
//         <Star
//           key={i}
//           className={`h-4 w-4 ${i < rating ? "fill-yellow-400 text-yellow-400" : "text-gray-300"}`}
//         />
//       ))}
//     </span>
//   );
// }

// export default function AccountManagementPage() {
//   const [clients, setClients] = useState<Client[]>([]);
//   const { loading, setLoading } = useContext(LoadingContext);
//   const [selectedClient, setSelectedClient] = useState<Client | null>(null);
//   const [historyDialogOpen, setHistoryDialogOpen] = useState(false);
//   const [feedbackDialogOpen, setFeedbackDialogOpen] = useState(false);
//   const [followUpDialogOpen, setFollowUpDialogOpen] = useState(false);
//   const [searchTerm, setSearchTerm] = useState("");
//   const [followUpFilter, setFollowUpFilter] = useState<"All dates" | "Today">("All dates");
//   const [feedbackForm, setFeedbackForm] = useState<Feedback>({
//     isHappy: false,
//     rating: 5,
//     notes: "",
//     willRenew: false,
//     date: new Date().toISOString().split("T")[0],
//   });
//   const [followUpForm, setFollowUpForm] = useState<FollowUp>({
//     date: "",
//     notes: "",
//   });
//   const [pendingStage, setPendingStage] = useState<AccountStage | null>(null);
//   const [callHistory, setCallHistory] = useState<any[]>([]); // Store call history data
//   const [clientFeedback, setClientFeedback] = useState<Feedback | null>(null); // Store client feedback data
//   const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
//   const [csvFile, setCsvFile] = useState<File | null>(null);
//   const [csvData, setCsvData] = useState<any[]>([]);
//   const [sortKey, setSortKey] = useState<"client_name" | "created_at" | null>(null);
//   const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc");


//   useEffect(() => {
//     const fetchClients = async () => {
//       setLoading(true);
//       try {

//         const { data: rawSalesData, error: salesError } = await supabase
//           .from("sales_closure")
//           .select("lead_id, email, onboarded_date")
//           .not("onboarded_date", "is", null)
//           .order("onboarded_date", { ascending: false });

//         if (salesError || !rawSalesData) {
//           console.error("‚ùå sales_closure fetch failed", salesError);
//           return;
//         }

//         const salesDataMap = new Map<string, { lead_id: string; email: string; onboarded_date: string }>();

//         for (const row of rawSalesData) {
//           if (!salesDataMap.has(row.lead_id)) {
//             salesDataMap.set(row.lead_id, row);
//           }
//         }

//         const salesData = Array.from(salesDataMap.values());
//         const leadIds = salesData.map((s) => s.lead_id);
//         const { data: leadsData, error: leadsError } = await supabase
//           .from("leads")
//           .select("business_id, name, phone, assigned_to, email")
//           .in("business_id", leadIds);

//         if (leadsError || !leadsData) {
//           console.error("‚ùå leads fetch failed", leadsError);
//           return;
//         }

//         const leadsMap = Object.fromEntries(leadsData.map((l) => [l.business_id, l]));
//         const { data: callRaw, error: callError } = await supabase
//           .from("call_history")
//           .select("lead_id, current_stage, followup_date")
//           .order("followup_date", { ascending: false });

//         if (callError) {
//           console.error("‚ùå call_history fetch failed", callError);
//         }

//         const latestCallMap: Record<string, any> = {};
//         for (const call of callRaw || []) {
//           if (!latestCallMap[call.lead_id]) {
//             latestCallMap[call.lead_id] = call;
//           }
//         }

//         const mergedClients: Client[] = salesData.map((sale) => {
//           const lead = leadsMap[sale.lead_id] || {};
//           const call = latestCallMap[sale.lead_id];

//           return {
//             id: sale.lead_id,
//             client_name: lead.name || "Unnamed",
//             email: sale.email || lead.email || "unknown@example.com",
//             phone: lead.phone || "N/A",
//             assigned_to: lead.assigned_to || "Unassigned",
//             created_at: sale.onboarded_date,
//             stage: (call?.current_stage as AccountStage) || "DNP",
//             follow_ups: [],
//             feedback: undefined,
//           };
//         });

//         setClients(mergedClients);
//       } catch (err) {
//         console.error("‚ùå Unexpected error:", err);
//       } finally {
//         setLoading(false);
//       }
//     };

//     fetchClients();
//   }, []);

//   useEffect(() => {
//     if (!historyDialogOpen || !selectedClient) {
//       setCallHistory([]);
//       setClientFeedback(null);
//       return;
//     }


//     const fetchCallHistoryAndFeedback = async () => {
//       const { data: callHistoryData, error: callHistoryError } = await supabase
//         .from("call_history")
//         .select("current_stage, followup_date, notes")
//         .eq("lead_id", selectedClient.id)
//         .order("followup_date", { ascending: false });

//       if (callHistoryError) {
//         console.error(`Error fetching call history for lead ${selectedClient.id}:`, JSON.stringify(callHistoryError, null, 2));
//       } else {
//         setCallHistory(callHistoryData || []);
//       }

//       if (selectedClient.stage === "Conversation Done") {
//         const { data: feedbackData, error: feedbackError } = await supabase
//           .from("client_feedback")
//           .select("*")
//           .eq("lead_id", selectedClient.id)
//           .order("id", { ascending: false })
//           .limit(1);

//         if (feedbackError) {
//           console.error(`Error fetching client feedback for lead ${selectedClient.id}:`, JSON.stringify(feedbackError, null, 2));
//         } else if (feedbackData?.[0]) {
//           setClientFeedback({
//             isHappy: feedbackData[0].client_emotion === "happy",
//             rating: parseInt(feedbackData[0].rating),
//             notes: feedbackData[0].notes,
//             willRenew: feedbackData[0].renew_status === "yes",
//             date: new Date().toISOString().split("T")[0], // Use current date as fallback
//           });
//         }
//       }
//     };

//     fetchCallHistoryAndFeedback();
//   }, [historyDialogOpen, selectedClient]);

//   const filteredClients = clients.filter((client) => {
//     const matchesSearch =
//       client.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
//       client.client_name.toLowerCase().includes(searchTerm.toLowerCase());

//     if (followUpFilter === "Today") {
//       const createdAt = new Date(client.created_at);
//       const now = new Date();
//       const diffInDays = Math.floor((now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24));
//       return diffInDays >= 15 && matchesSearch;
//     }

//     return matchesSearch;
//   });

//   const sortedClients = [...filteredClients].sort((a, b) => {
//     if (!sortKey) return 0;

//     const valA = a[sortKey]?.toLowerCase?.() || a[sortKey];
//     const valB = b[sortKey]?.toLowerCase?.() || b[sortKey];

//     if (sortOrder === "asc") {
//       return valA > valB ? 1 : -1;
//     } else {
//       return valA < valB ? 1 : -1;
//     }
//   });

//   const handleSort = (key: "client_name" | "created_at") => {
//     if (sortKey === key) {
//       setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
//     } else {
//       setSortKey(key);
//       setSortOrder("asc");
//     }
//   };


//   // function getRenewWithinStatus(closedAt: string): string {
//   //   const closedDate = new Date(closedAt);
//   //   const today = new Date();

//   //   const diffInTime = today.getTime() - closedDate.getTime();
//   //   const diffInDays = Math.floor(diffInTime / (1000 * 60 * 60 * 24));

//   //   const renewalWindow = 15;

//   //   if (diffInDays < renewalWindow) {
//   //     const remaining = renewalWindow - diffInDays;
//   //     return `Within ${remaining} day${remaining === 1 ? "" : "s"}`;
//   //   } else {
//   //     const overdue = diffInDays - renewalWindow;
//   //     return `Overdue by ${overdue} day${overdue === 1 ? "" : "s"}`;
//   //   }
//   // }


//   const getRenewWithinBadge = (createdAt: string): React.ReactNode => {
//     if (!createdAt) return "-";

//     const closedDate = new Date(createdAt);
//     const today = new Date();
//     const diffInDays = Math.floor(
//       (today.getTime() - closedDate.getTime()) / (1000 * 60 * 60 * 24)
//     );

//     if (diffInDays < 15) {
//       const daysLeft = 15 - diffInDays;
//       return (
//         <Badge className="bg-green-100 text-green-800">
//           Within {daysLeft} day{daysLeft === 1 ? "" : "s"}
//         </Badge>
//       );
//     }
//     else if (diffInDays == 15) {

//       return (
//         <Badge className="bg-yellow-100 text-gray-800">
//           Today lastdate
//         </Badge>
//       );
//     }
//     else {
//       const overdueDays = diffInDays - 15;
//       return (
//         <Badge className="bg-red-100 text-red-800">
//           Overdue by {overdueDays} day{overdueDays === 1 ? "" : "s"}
//         </Badge>
//       );
//     }
//   };

//   const handleStageUpdate = (clientId: string, newStage: AccountStage) => {
//     setClients((prev) => prev.map((client) => (client.id === clientId ? { ...client, stage: newStage } : client)));

//     const updatedClient = clients.find((c) => c.id === clientId);
//     if (!updatedClient) return;

//     const clientWithUpdatedStage = { ...updatedClient, stage: newStage };
//     setSelectedClient(clientWithUpdatedStage);

//     if (newStage === "Conversation Done") {
//       setFeedbackForm({
//         isHappy: false,
//         rating: 5,
//         notes: "",
//         willRenew: false,
//         date: new Date().toISOString().split("T")[0],
//       });
//       setFeedbackDialogOpen(true);
//     } else if (newStage === "DNP" || newStage === "Call Again") {
//       setPendingStage(newStage);
//       setFollowUpForm({
//         date: new Date().toISOString().split("T")[0],
//         notes: "",
//       });
//       setFollowUpDialogOpen(true);
//     }
//   };

//   const handleFeedbackSubmit = async () => {
//     if (!selectedClient) {
//       console.error("No client selected");
//       alert("No client selected. Please try again.");
//       return;
//     }

//     if (!feedbackForm.rating || feedbackForm.rating < 1 || feedbackForm.rating > 5) {
//       alert("Please select a valid rating between 1 and 5.");
//       return;
//     }

//     if (!feedbackForm.notes || feedbackForm.notes.trim() === "") {
//       alert("Please provide feedback notes.");
//       return;
//     }

//     if (typeof feedbackForm.willRenew !== "boolean") {
//       alert("Please select if the client will renew.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email === "N/A" || selectedClient.email.trim() === ""
//         ? "unknown@example.com"
//         : selectedClient.email;

//     const { data: leadCheck, error: leadCheckError } = await supabase
//       .from("leads")
//       .select("business_id")
//       .eq("business_id", selectedClient.id)
//       .limit(1);

//     if (leadCheckError || !leadCheck || leadCheck.length === 0) {
//       console.error("Lead not found with business_id:", selectedClient.id);
//       alert("Lead does not exist. Please create the lead first.");
//       return;
//     }

//     const feedbackData = {
//       lead_id: selectedClient.id, // üí• Using business_id directly
//       client_emotion: feedbackForm.isHappy ? "happy" : "unhappy",
//       rating: feedbackForm.rating.toString(),
//       notes: feedbackForm.notes.trim(),
//       renew_status: feedbackForm.willRenew ? "yes" : "no",
//       email: emailToUse,
//     };

//     const { data, error } = await supabase
//       .from("client_feedback")
//       .insert([feedbackData])
//       .select();

//     if (error) {
//       console.error("Error saving feedback:", JSON.stringify(error, null, 2));
//       alert(`Failed to save feedback: ${error.message}`);
//       return;
//     }

//     setClients((prev) =>
//       prev.map((client) =>
//         client.id === selectedClient.id ? { ...client, feedback: feedbackForm } : client
//       )
//     );

//     setFeedbackDialogOpen(false);
//     setFeedbackForm({
//       isHappy: false,
//       rating: 5,
//       notes: "",
//       willRenew: false,
//       date: new Date().toISOString().split("T")[0],
//     });

//     console.log("‚úÖ Feedback saved successfully for lead:", selectedClient.id);
//   };


//   const handleFollowUpSave = async () => {
//     if (!selectedClient || !pendingStage) {
//       console.error("No client or stage selected");
//       alert("No client or stage selected. Please try again.");
//       return;
//     }

//     if (!followUpForm.date || !followUpForm.notes.trim()) {
//       alert("Please provide a follow-up date and notes.");
//       return;
//     }

//     const emailToUse = !selectedClient.email || selectedClient.email === "N/A" || selectedClient.email.trim() === ""
//       ? "unknown@example.com"
//       : selectedClient.email;

//     const phoneToUse = !selectedClient.phone || selectedClient.phone === "N/A" || selectedClient.phone.trim() === ""
//       ? null
//       : selectedClient.phone;

//     const followUpData = {
//       lead_id: selectedClient.id, // Use business_id as lead_id in call_history
//       current_stage: pendingStage,
//       followup_date: followUpForm.date,
//       notes: followUpForm.notes.trim(),
//       assigned_to: selectedClient.assigned_to || "Unassigned",
//       email: emailToUse,
//       phone: phoneToUse,
//     };

//     const { data, error } = await supabase.from("call_history").insert([followUpData]);

//     if (error) {
//       console.error("Error saving follow-up:", error);
//       alert("Failed to save follow-up. Please try again.");
//     } else {
//       setClients((prev) =>
//         prev.map((client) =>
//           client.id === selectedClient.id
//             ? {
//               ...client,
//               stage: pendingStage,
//               follow_ups: [
//                 ...(client.follow_ups || []),
//                 { date: followUpForm.date, notes: followUpForm.notes },
//               ],
//             }
//             : client
//         )
//       );
//       setFollowUpDialogOpen(false);
//       setFollowUpForm({ date: "", notes: "" });
//       setPendingStage(null);
//     }
//   };



//   const handleCSVUpload = (file: File) => {
//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const requiredFields = ['Name', 'Rate', 'Payment Frequency', 'sale_done', 'Onboarded date', 'Phone number', 'email'];
//         const fields: string[] = Array.isArray(results.meta.fields) ? results.meta.fields as string[] : [];
//         const missingFields = requiredFields.filter(field => !fields.includes(field));

//         if (missingFields.length > 0) {
//           alert(`Missing required columns: ${missingFields.join(', ')}`);
//           return;
//         }

//         setCsvData(results.data);
//       },
//       error: function (error) {
//         console.error("CSV parsing error:", error);
//         alert("Failed to parse CSV.");
//       },
//     });
//   };


//   // const handleCSVSubmit = async () => {
//   //   if (csvData.length === 0) {
//   //     alert("No CSV data to submit");
//   //     return;
//   //   }
//   //   const uniqueNames = [...new Set(csvData.map((row) => row.Name?.trim()).filter(Boolean))];
//   //   const { data: leads, error: leadsError } = await supabase
//   //     .from("leads")
//   //     .select("name, business_id, email")
//   //     .in("name", uniqueNames);

//   //   if (leadsError) {
//   //     console.error("Error fetching leads:", leadsError);
//   //     alert("Failed to fetch lead data from database.");
//   //     return;
//   //   }

//   //   const nameToLeadDetailsMap: Record<string, { lead_id: string; email: string }> = {};
//   //   leads.forEach((lead) => {
//   //     if (lead.name && lead.business_id && lead.email) {
//   //       nameToLeadDetailsMap[lead.name.trim()] = {
//   //         lead_id: lead.business_id,
//   //         email: lead.email,
//   //       };
//   //     }
//   //   });

//   //   const formattedRows = csvData
//   //     .map((row) => {
//   //       const trimmedName = row.Name?.trim();
//   //       const leadDetails = nameToLeadDetailsMap[trimmedName];

//   //       if (!leadDetails) {
//   //         console.warn(`‚ùå No lead info found for Name: ${trimmedName}`);
//   //         return null;
//   //       }
//   //       const closedAt = row.closed_at;

//   //       return {
//   //         lead_id: leadDetails.lead_id,
//   //         sale_value: Number(row.sale_value),
//   //         subscription_cycle: Number(row.subscription_cycle),
//   //         payment_mode: "UPI",
//   //         closed_at: closedAt,
//   //         email: leadDetails.email,
//   //         finance_status: row.finance_status || "Paid",
//   //         onboarded_date: closedAt, // Assuming onboarded_date is same as closed_at
//   //       };
//   //     })
//   //     .filter(Boolean);

//   //   if (formattedRows.length === 0) {
//   //     alert("No valid rows to insert (possibly due to unmatched names).");
//   //     return;
//   //   }

//   //   try {
//   //     const { error } = await supabase
//   //       .from("sales_closure")
//   //       .insert(formattedRows);

//   //     if (error) {
//   //       console.error("Upload failed:", error);
//   //       alert(`Upload failed: ${error.message}`);
//   //       return;
//   //     }

//   //     alert(`üéâ Successfully uploaded ${formattedRows.length} records.`);
//   //     setUploadDialogOpen(false);
//   //     setCsvData([]);
//   //     setCsvFile(null);
//   //   } catch (err) {
//   //     console.error("Unexpected error:", err);
//   //     alert("An unexpected error occurred during upload");
//   //   }
//   // };


//   // const handleCSVSubmit = async () => {
//   //   if (csvData.length === 0) {
//   //     alert("No CSV data to submit");
//   //     return;
//   //   }

//   //   try {
//   //     // Step 1: Fetch existing AWL IDs
//   //     const { data: existingLeads, error: leadsError } = await supabase
//   //       .from("leads")
//   //       .select("business_id");

//   //     if (leadsError) throw leadsError;

//   //     const existingIds = (existingLeads || [])
//   //       .map((l) => l.business_id)
//   //       .filter(Boolean)
//   //       .map((id) => parseInt(id?.replace("AWL-", ""), 10))
//   //       .filter((n) => !isNaN(n));

//   //     let awlCounter = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;

//   //     // Step 2: Prepare batch inserts
//   //     const leadsToInsert = [];
//   //     const salesToInsert = [];

//   //     for (const row of csvData) {
//   //       const name = row["Name"]?.trim();
//   //       const phone = row["Phone number"]?.trim() || null;
//   //       const email = row["email"]?.trim();
//   //       const sale_value = parseFloat(row["Rate"]);
//   //       const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//   //       const date = new Date(row["Onboarded date"]);

//   //       const business_id = `AWL-${awlCounter++}`;

//   //       leadsToInsert.push({
//   //         name,
//   //         email,
//   //         phone,
//   //         created_at: date.toISOString(),
//   //         city: "Unknown",
//   //         source: "Directly dumped",
//   //         status: "Assigned",
//   //         business_id,
//   //         current_stage: "sale done",
//   //       });

//   //       salesToInsert.push({
//   //         lead_id: business_id,
//   //         lead_name: name,
//   //         email,
//   //         sale_value,
//   //         subscription_cycle,
//   //         payment_mode: "UPI",
//   //         finance_status: "Paid",
//   //         closed_at: date.toISOString(),
//   //         onboarded_date: date.toISOString().split("T")[0],
//   //       });
//   //     }

//   //     // Step 3: Insert to Supabase
//   //     const { error: leadInsertError } = await supabase.from("leads").insert(leadsToInsert);
//   //     if (leadInsertError) throw leadInsertError;

//   //     const { error: saleInsertError } = await supabase.from("sales_closure").insert(salesToInsert);
//   //     if (saleInsertError) throw saleInsertError;

//   //     alert(`üéâ Inserted ${leadsToInsert.length} records successfully`);
//   //     setUploadDialogOpen(false);
//   //     setCsvData([]);
//   //     setCsvFile(null);
//   //   } catch (err) {
//   //     console.error("‚ùå Upload failed:", err);
//   //     const errorMsg = err instanceof Error ? err.message : String(err);
//   //     alert(`Upload failed: ${errorMsg}`);
//   //   }
//   // };


//   const handleCSVSubmit = async () => {
//     if (csvData.length === 0) {
//       alert("No CSV data to submit");
//       return;
//     }

//     try {
//       const salesToInsert = [];

//       // for (const row of csvData) {
//       //   const lead_id = row["lead_id"]?.trim();
//       //   const name = row["Name"]?.trim();
//       //   const email = row["email"]?.trim();
//       //   // const phone = row["Phone number"]?.trim() || null;
//       //   const sale_value = parseFloat(row["Rate"]);
//       //   const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//       //   const date = new Date(row["Onboarded date"]);
//       //   const sale_done = new Date(row["sale_done"]);

//       //   if (!lead_id || !name || !email || !sale_value || !subscription_cycle || isNaN(date.getTime())) {
//       //     console.warn("‚ùå Skipping invalid row:", row);
//       //     continue;
//       //   }

//       //   salesToInsert.push({
//       //     lead_id,
//       //     lead_name: name,
//       //     email,
//       //     // phone,
//       //     sale_value,
//       //     subscription_cycle,
//       //     payment_mode: "UPI",
//       //     finance_status: "Paid",
//       //     closed_at: sale_done.toISOString(),
//       //     onboarded_date: date.toISOString().split("T")[0],
//       //   });
//       // }

//       for (const row of csvData) {
//         const lead_id = row["lead_id"]?.trim();
//         const name = row["Name"]?.trim();
//         const email = row["email"]?.trim();
//         const sale_value = parseFloat(row["Rate"]);
//         const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//         const date = new Date(row["Onboarded date"]);
//         const sale_done = new Date(row["sale_done"]);

//         if (
//           !lead_id ||
//           !name ||
//           !email ||
//           !sale_value ||
//           !subscription_cycle ||
//           isNaN(date.getTime()) ||
//           isNaN(sale_done.getTime())
//         ) {
//           console.warn("‚ùå Skipping invalid row:", row);
//           if (isNaN(date.getTime())) console.warn("‚õî Invalid Onboarded date:", row["Onboarded date"]);
//           if (isNaN(sale_done.getTime())) console.warn("‚õî Invalid sale_done date:", row["sale_done"]);
//           continue;
//         }

//         salesToInsert.push({
//           lead_id,
//           lead_name: name,
//           email,
//           sale_value,
//           subscription_cycle,
//           payment_mode: "UPI",
//           finance_status: "Paid",
//           closed_at: sale_done.toISOString(),
//           onboarded_date: date.toISOString().split("T")[0],
//         });
//       }


//       if (salesToInsert.length === 0) {
//         alert("No valid rows to upload.");
//         return;
//       }

//       const { error } = await supabase.from("sales_closure").insert(salesToInsert);

//       if (error) throw error;

//       alert(`üéâ Successfully inserted ${salesToInsert.length} renewal records into sales_closure`);
//       setUploadDialogOpen(false);
//       setCsvData([]);
//       setCsvFile(null);
//     } catch (err) {
//       console.error("‚ùå Upload failed:", err);
//       const errorMsg = err instanceof Error ? err.message : String(err);
//       alert(`Upload failed: ${errorMsg}`);
//     }
//   };

//   return (
//     <>
//       {loading && <FullScreenLoader />}
//       <ProtectedRoute allowedRoles={["Account Management", "Super Admin"]}>

//         <DashboardLayout>
//           <div className="space-y-6">
//             <div className="flex justify-between items-center">
//               <div>
//                 <h1 className="text-3xl font-bold text-gray-900">Account Management CRM</h1>
//                 <p className="text-gray-600 mt-2">Manage client relationships and feedback</p>
//               </div>
//               <div className="flex justify-end mb-4">
//                 <Button onClick={() => setUploadDialogOpen(true)}>Upload Sale Done CSV</Button>
//               </div>
//             </div>


//             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Happy Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.filter((c) => c.feedback?.isHappy).length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Renewal Intent</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.filter((c) => c.feedback?.willRenew).length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Avg Rating</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">
//                     {clients.filter((c) => c.feedback).length > 0
//                       ? (
//                         clients.filter((c) => c.feedback).reduce((sum, c) => sum + (c.feedback?.rating || 0), 0) /
//                         clients.filter((c) => c.feedback).length
//                       ).toFixed(1)
//                       : "N/A"}
//                   </div>
//                 </CardContent>
//               </Card>
//             </div>

//             <Card>
//               <CardHeader>
//                 <CardTitle>Account Management Dashboard</CardTitle>
//                 <CardDescription>Manage client accounts and track feedback</CardDescription>
//               </CardHeader>
//               <CardContent>
//                 <div className="flex items-center justify-between mt-4">
//                   <Input
//                     placeholder="Search by email or name"
//                     value={searchTerm}
//                     onChange={(e) => setSearchTerm(e.target.value)}
//                     className="max-w-md"
//                   />

//                   <Select value={followUpFilter} onValueChange={(value) => setFollowUpFilter(value as "All dates" | "Today")}>
//                     <SelectTrigger className="w-40">
//                       <SelectValue placeholder="Follow Up" />
//                     </SelectTrigger>
//                     <SelectContent>
//                       <SelectItem value="All dates">All dates</SelectItem>
//                       <SelectItem value="Today">Today</SelectItem>
//                     </SelectContent>
//                   </Select>
//                 </div>

//                 <div className="rounded-md border mt-6">
//                   <Table>
//                     <TableHeader>
//                       <TableRow>
//                         <TableHead>S.No</TableHead>
//                         {/* <TableHead>Client Name</TableHead> */}
//                         <TableHead className="flex items-center gap-1 select-none">
//                           <div className="flex flex-center gap-1">
//                             Client Name

//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"
//                                 }`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("desc");
//                               }}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"
//                                 }`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Email</TableHead>
//                         <TableHead>Phone</TableHead>
//                         <TableHead>Assigned To</TableHead>
//                         <TableHead>Stage</TableHead>
//                         {/* <TableHead>Closed At</TableHead> */}
//                         <TableHead className="flex items-center gap-1 select-none">
//                           <div className="flex flex-center gap-1">
//                             Closed At

//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"
//                                 }`}
//                               onClick={() => {
//                                 setSortKey("created_at");
//                                 setSortOrder("desc");
//                               }}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"
//                                 }`}
//                               onClick={() => {
//                                 setSortKey("created_at");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Deadline</TableHead>
//                         <TableHead>Actions</TableHead>
//                       </TableRow>
//                     </TableHeader>
//                     <TableBody>
//                       {sortedClients.map((client, idx) => (
//                         <TableRow key={client.id}>
//                           <TableCell>{idx + 1}</TableCell>
//                           {/* <TableCell className="font-medium">{client.client_name}</TableCell> */}
//                           <TableCell
//                             className="font-medium max-w-[150px] break-words whitespace-normal cursor-pointer text-blue-600 hover:underline"
//                             onClick={() => window.open(`/leads/${client.id}`, "_blank")}
//                           >
//                             {client.client_name}
//                           </TableCell>
//                           <TableCell>{client.email}</TableCell>
                          
//                           <TableCell>{client.phone || "-"}</TableCell>
//                           <TableCell>{client.assigned_to}</TableCell>
//                           <TableCell>
//                             <Select
//                               value={accountStages.includes(client.stage) ? client.stage : undefined}
//                               onValueChange={(value: AccountStage) => handleStageUpdate(client.id, value)}
//                             >
//                               <SelectTrigger className="w-40">
//                                 <SelectValue placeholder="Select Stage" />
//                               </SelectTrigger>
//                               <SelectContent>
//                                 {accountStages.map((stage) => (
//                                   <SelectItem key={stage} value={stage}>
//                                     <Badge className={getStageColor(stage)}>{stage}</Badge>
//                                   </SelectItem>
//                                 ))}
//                               </SelectContent>
//                             </Select>
//                           </TableCell>
//                           <TableCell>{formatDate(client.created_at)}</TableCell>
//                           <TableCell>{getRenewWithinBadge(client.created_at)}</TableCell>
//                           <TableCell>
//                             <div className="flex gap-2">
//                               <Button
//                                 size="sm"
//                                 variant="outline"
//                                 onClick={() => {
//                                   setSelectedClient(client);
//                                   setHistoryDialogOpen(true);
//                                 }}
//                               >
//                                 <Eye className="h-4 w-4" />
//                               </Button>
//                               <Button
//                                 size="sm"
//                                 variant="outline"
//                                 onClick={() => {
//                                   setSelectedClient(client);
//                                   if (client.feedback) {
//                                     setFeedbackForm(client.feedback);
//                                   }
//                                   setFeedbackDialogOpen(true);
//                                 }}
//                               >
//                                 <MessageSquare className="h-4 w-4" />
//                               </Button>
//                             </div>
//                           </TableCell>
//                         </TableRow>
//                       ))}
//                     </TableBody>
//                   </Table>
//                 </div>
//               </CardContent>
//             </Card>

//             <Dialog open={historyDialogOpen} onOpenChange={setHistoryDialogOpen}>
//               <DialogContent className="max-w-2xl">
//                 <DialogHeader>
//                   <DialogTitle>{selectedClient?.client_name} - Full History</DialogTitle>
//                   <DialogDescription>Complete follow-up history and client interactions</DialogDescription>
//                 </DialogHeader>

//                 {selectedClient && (
//                   <div className="space-y-6">
//                     <div className="grid grid-cols-2 gap-4">
//                       <div>
//                         <Label className="text-sm font-medium">Email</Label>
//                         <p className="text-sm text-gray-600">{selectedClient.email}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Assigned To</Label>
//                         <p className="text-sm text-gray-600">{selectedClient.assigned_to}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Current Stage</Label>
//                         <Badge className={getStageColor(selectedClient.stage)}>{selectedClient.stage}</Badge>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Closed</Label>
//                         <p className="text-sm text-gray-600">{formatDate(selectedClient.created_at)}</p>
//                       </div>
//                     </div>

//                     <div>
//                       <Label className="text-sm font-medium mb-3 block">Follow-up History</Label>
//                       <div className="space-y-3 max-h-64 overflow-y-auto">
//                         {callHistory.length > 0 ? (
//                           callHistory.map((entry, index) => (
//                             <div key={index} className="p-3 bg-gray-50 rounded-lg">
//                               <div className="flex items-center gap-2 mb-2">
//                                 <Calendar className="h-4 w-4 text-gray-500" />
//                                 <span className="text-sm font-medium">{entry.followup_date}</span>
//                               </div>
//                               <div className="mb-2">
//                                 <span className="text-sm font-medium">Stage: </span>
//                                 <Badge className={getStageColor(entry.current_stage)}>{entry.current_stage}</Badge>
//                               </div>
//                               <p className="text-sm text-gray-600">{entry.notes}</p>
//                             </div>
//                           ))
//                         ) : (
//                           <p className="text-sm text-gray-600">No follow-up history available.</p>
//                         )}
//                       </div>
//                     </div>

//                     {selectedClient.stage === "Conversation Done" && clientFeedback && (
//                       <div>
//                         <Label className="text-sm font-medium mb-3 block">Latest Feedback</Label>
//                         <div className="p-3 bg-blue-50 rounded-lg space-y-2">
//                           <div className="flex items-center justify-between">
//                             <div className="flex items-center gap-2">
//                               <span className="text-sm font-medium">Rating:</span>
//                               <div className="flex">{renderStars(clientFeedback.rating)}</div>
//                             </div>
//                             <Badge variant={clientFeedback.isHappy ? "default" : "secondary"}>
//                               {clientFeedback.isHappy ? "Happy" : "Needs Attention"}
//                             </Badge>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Will Renew: </span>
//                             <span
//                               className={`text-sm ${clientFeedback.willRenew ? "text-green-600" : "text-red-600"}`}
//                             >
//                               {clientFeedback.willRenew ? "Yes" : "No"}
//                             </span>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Notes: </span>
//                             <p className="text-sm text-gray-600 mt-1">{clientFeedback.notes}</p>
//                           </div>
//                           <div className="text-xs text-gray-500">Feedback Date: {clientFeedback.date}</div>
//                         </div>
//                       </div>
//                     )}
//                   </div>
//                 )}
//               </DialogContent>
//             </Dialog>

//             <Dialog open={feedbackDialogOpen} onOpenChange={setFeedbackDialogOpen}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Client Feedback</DialogTitle>
//                   <DialogDescription>Collect feedback from {selectedClient?.client_name}</DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Is Client Happy?</Label>
//                     <Select
//                       value={feedbackForm.isHappy ? "happy" : "unhappy"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, isHappy: value === "happy" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="happy">Happy</SelectItem>
//                         <SelectItem value="unhappy">Unhappy</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Rating (1-5)</Label>
//                     <Select
//                       value={feedbackForm.rating.toString()}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, rating: Number(value) }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         {[1, 2, 3, 4, 5].map((rating) => (
//                           <SelectItem key={rating} value={rating.toString()}>
//                             <div className="flex items-center gap-2">
//                               <span>{rating}</span>
//                               <div className="flex">{renderStars(rating)}</div>
//                             </div>
//                           </SelectItem>
//                         ))}
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label>Notes</Label>
//                     <Textarea
//                       placeholder="Enter detailed feedback..."
//                       value={feedbackForm.notes}
//                       onChange={(e) => setFeedbackForm((prev) => ({ ...prev, notes: e.target.value }))}
//                     />
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Will Client Renew?</Label>
//                     <Select
//                       value={feedbackForm.willRenew ? "yes" : "no"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, willRenew: value === "yes" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="yes">Yes</SelectItem>
//                         <SelectItem value="no">No</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setFeedbackDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFeedbackSubmit}>Save Feedback</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             <Dialog open={followUpDialogOpen} onOpenChange={setFollowUpDialogOpen} >
//               <DialogContent >
//                 <DialogHeader>
//                   <DialogTitle>Schedule Follow-up</DialogTitle>
//                 </DialogHeader>
//                 <div className="space-y-4">
//                   <div>
//                     <Label className="block mb-1">Follow-up Date</Label>
//                     <Input
//                       type="date"
//                       value={followUpForm.date}
//                       onChange={e => setFollowUpForm(f => ({ ...f, date: e.target.value }))}
//                       placeholder="dd-mm-yyyy"
//                       className="w-full"
//                     />
//                   </div>
//                   <div>
//                     <Label className="block mb-1">Notes</Label>
//                     <Textarea
//                       placeholder="Add notes..."
//                       value={followUpForm.notes}
//                       onChange={e => setFollowUpForm(f => ({ ...f, notes: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                 </div>
//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setFollowUpDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFollowUpSave}>
//                     Save Follow-up
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>
//               <DialogContent className="max-w-5xl">
//                 <DialogHeader>
//                   <DialogTitle>Upload Sale Done CSV</DialogTitle>
//                   <DialogDescription>
//                     Upload your sales CSV. We'll parse and show the number of entries.<br></br>
//                     The csv file must contain columns like below:<br></br>
//                     "lead_id, Name, Rate, Payment Frequency, sale_done, Onboarded date, Phone number, email"<br></br>
//                     sale_done and Onboarded date date format like üëâ (yyyy-mm-dd)

//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Input
//                     type="file"
//                     accept=".csv"
//                     onChange={(e) => {
//                       const file = e.target.files?.[0];
//                       if (file) {
//                         setCsvFile(file);
//                         handleCSVUpload(file);
//                       }
//                     }}
//                   />
//                   <p className="text-sm text-gray-600">
//                     {csvData.length > 0
//                       ? `‚úÖ Detected ${csvData.length} records in file.`
//                       : "No file parsed yet."}
//                   </p>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setUploadDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleCSVSubmit} disabled={csvData.length === 0}>
//                     Submit to Supabase
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//           </div>
//         </DashboardLayout>
//       </ProtectedRoute>
//     </>
//   );
// }



// // app/account-management/page.tsx
// "use client";

// import * as React from "react";
// import { useEffect, useMemo, useRef, useState, useContext } from "react";
// import { supabase } from "@/utils/supabase/client";
// import { DashboardLayout } from "@/components/layout/dashboard-layout";
// import { Button } from "@/components/ui/button";
// import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
// import { Badge } from "@/components/ui/badge";
// import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
// import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
// import { Input } from "@/components/ui/input";
// import { Label } from "@/components/ui/label";
// import { Textarea } from "@/components/ui/textarea";
// import { Eye, MessageSquare, Star, Calendar } from "lucide-react";
// import ProtectedRoute from "@/components/auth/ProtectedRoute";
// import Papa from "papaparse";
// import { LoadingContext } from "@/components/providers/LoadingContext";
// import FullScreenLoader from "@/components/ui/FullScreenLoader";

// type AccountStage = "DNP" | "Call Again" | "Conversation Done";

// interface FollowUp {
//   date: string;
//   notes: string;
// }

// interface Feedback {
//   isHappy: boolean;
//   rating: number;
//   notes: string;
//   willRenew: boolean;
//   date: string; // yyyy-mm-dd
// }

// interface Client {
//   id: string;
//   client_name: string;
//   email: string;
//   phone?: string | null;
//   assigned_to: string;
//   stage: AccountStage;
//   created_at: string; // ISO or yyyy-mm-dd
//   follow_ups?: FollowUp[];
//   feedback?: Feedback;
// }

// const accountStages: AccountStage[] = ["DNP", "Call Again", "Conversation Done"];

// const getStageColor = (stage: AccountStage) => {
//   switch (stage) {
//     case "DNP":
//       return "bg-yellow-100 text-yellow-800";
//     case "Call Again":
//       return "bg-blue-100 text-blue-800";
//     case "Conversation Done":
//       return "bg-green-100 text-green-800";
//     default:
//       return "bg-gray-100 text-gray-800";
//   }
// };

// const formatDate = (dateString: string | undefined): string => {
//   if (!dateString) return "N/A";
//   const d = new Date(dateString);
//   return isNaN(d.getTime()) ? "N/A" : d.toLocaleDateString();
// };

// function renderStars(rating: number) {
//   return (
//     <span className="flex">
//       {Array.from({ length: 5 }, (_, i) => (
//         <Star
//           key={i}
//           className={`h-4 w-4 ${i < rating ? "fill-current text-yellow-400" : "text-gray-300"}`}
//         />
//       ))}
//     </span>
//   );
// }

// export default function AccountManagementPage() {
//   const [clients, setClients] = useState<Client[]>([]);
//   // const { loading, setLoading } = useContext(LoadingContext);
//   const [selectedClient, setSelectedClient] = useState<Client | null>(null);

//   // dialogs
//   const [historyDialogOpen, setHistoryDialogOpen] = useState(false);
//   const [feedbackDialogOpen, setFeedbackDialogOpen] = useState(false);
//   const [followUpDialogOpen, setFollowUpDialogOpen] = useState(false);

//   const [pageLoading, setPageLoading] = useState(false);


//   // controls
//   const [searchTerm, setSearchTerm] = useState("");
//   const [followUpFilter, setFollowUpFilter] = useState<"All dates" | "Today">("All dates");
//   const [sortKey, setSortKey] = useState<"client_name" | "created_at" | null>(null);
//   const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc");

//   // forms
//   const [feedbackForm, setFeedbackForm] = useState<Feedback>({
//     isHappy: false,
//     rating: 5,
//     notes: "",
//     willRenew: false,
//     date: new Date().toISOString().split("T")[0],
//   });
//   const [followUpForm, setFollowUpForm] = useState<FollowUp>({ date: "", notes: "" });

//   // state needed to revert stage on cancel
//   const [pendingStage, setPendingStage] = useState<AccountStage | null>(null);
//   const prevStageRef = useRef<AccountStage | null>(null);
//   const changeCommittedRef = useRef<boolean>(false);

//   // modal content
//   const [callHistory, setCallHistory] = useState<any[]>([]);
//   const [clientFeedback, setClientFeedback] = useState<Feedback | null>(null);

//   // csv
//   const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
//   const [csvFile, setCsvFile] = useState<File | null>(null);
//   const [csvData, setCsvData] = useState<any[]>([]);

//   // ---- initial load: build client list & attach latest feedback
//   useEffect(() => {

//      let cancelled = false;

//     const fetchClients = async () => {
//       setPageLoading(true);
//       try {
//         // 1) sales with onboarded_date
//         const { data: rawSalesData, error: salesError } = await supabase
//           .from("sales_closure")
//           .select("lead_id, email, onboarded_date")
//           .not("onboarded_date", "is", null)
//           .order("onboarded_date", { ascending: false });

//         if (salesError || !rawSalesData) {
//           console.error("‚ùå sales_closure fetch failed", salesError);
//           return;
//         }

//         // dedupe by lead_id keeping latest onboarded_date (already sorted desc)
//         const salesDataMap = new Map<string, { lead_id: string; email: string; onboarded_date: string }>();
//         for (const row of rawSalesData) {
//           if (!salesDataMap.has(row.lead_id)) salesDataMap.set(row.lead_id, row);
//         }
//         const salesData = Array.from(salesDataMap.values());
//         const leadIds = salesData.map((s) => s.lead_id);

//         // 2) leads info
//         const { data: leadsData, error: leadsError } = await supabase
//           .from("leads")
//           .select("business_id, name, phone, assigned_to, email")
//           .in("business_id", leadIds);

//         if (leadsError || !leadsData) {
//           console.error("‚ùå leads fetch failed", leadsError);
//           return;
//         }
//         const leadsMap = Object.fromEntries(leadsData.map((l) => [l.business_id, l]));

//         // 3) latest call per lead
//         const { data: callRaw, error: callError } = await supabase
//           .from("call_history")
//           .select("lead_id, current_stage, followup_date")
//           .order("followup_date", { ascending: false });

//         if (callError) console.error("‚ùå call_history fetch failed", callError);

//         const latestCallMap: Record<string, any> = {};
//         for (const call of callRaw || []) {
//           if (!latestCallMap[call.lead_id]) latestCallMap[call.lead_id] = call;
//         }

//         // 4) latest feedback per lead (for dashboard counters & table chips)
//         const { data: feedbackRows, error: fbErr } = await supabase
//           .from("client_feedback")
//           .select("lead_id, client_emotion, rating, notes, renew_status")
//           .in("lead_id", leadIds)
//           .order("id", { ascending: false });

//         if (fbErr) console.error("‚ö†Ô∏è client_feedback fetch failed", fbErr);

//         const latestFbMap = new Map<string, Feedback>();
//         for (const r of feedbackRows || []) {
//           if (!latestFbMap.has(r.lead_id)) {
//             latestFbMap.set(r.lead_id, {
//               isHappy: r.client_emotion === "happy",
//               rating: parseInt(String(r.rating || "0"), 10),
//               notes: r.notes || "",
//               willRenew: r.renew_status === "yes",
//               // date: (r.created_at ? String(r.created_at) : new Date().toISOString()).split("T")[0],
//               date: new Date().toISOString().split("T")[0],

//             });
//           }
//         }

//         // 5) merge
//         const mergedClients: Client[] = salesData.map((sale) => {
//           const lead = leadsMap[sale.lead_id] || {};
//           const call = latestCallMap[sale.lead_id];
//           return {
//             id: sale.lead_id,
//             client_name: lead.name || "Unnamed",
//             email: sale.email || lead.email || "unknown@example.com",
//             phone: lead.phone ?? null,
//             assigned_to: lead.assigned_to || "Unassigned",
//             created_at: sale.onboarded_date,
//             stage: (call?.current_stage as AccountStage) || "DNP",
//             follow_ups: [],
//             feedback: latestFbMap.get(sale.lead_id),
//           };
//         });

//   if (!cancelled) {
//         setClients(mergedClients); // keep your variable name
//       }}
//       catch (err) {
//         console.error("‚ùå Unexpected error:", err);
//       } finally {
//   if (!cancelled) setPageLoading(false);      }
//     };

//     fetchClients();
//   return () => {
//     cancelled = true; // prevents setting state after unmount / HMR
//   };
// }, []);

//   // ---- modal fetch: history + latest feedback for selected client
//   useEffect(() => {
//     if (!historyDialogOpen || !selectedClient) {
//       setCallHistory([]);
//       setClientFeedback(null);
//       return;
//     }

//     const fetchCallHistoryAndFeedback = async () => {
//       const { data: callHistoryData, error: callHistoryError } = await supabase
//         .from("call_history")
//         .select("current_stage, followup_date, notes")
//         .eq("lead_id", selectedClient.id)
//         .order("followup_date", { ascending: false });

//       if (callHistoryError) {
//         console.error(`Error fetching call history for lead ${selectedClient.id}:`, JSON.stringify(callHistoryError, null, 2));
//       } else {
//         setCallHistory(callHistoryData || []);
//       }

//       const { data: feedbackData, error: feedbackError } = await supabase
//         .from("client_feedback")
//         .select("client_emotion, rating, notes, renew_status, id")
//         .eq("lead_id", selectedClient.id)
//         .order("id", { ascending: false })
//         .limit(1);

//       if (feedbackError) {
//         console.error(`Error fetching client feedback for lead ${selectedClient.id}:`, JSON.stringify(feedbackError, null, 2));
//       } else if (feedbackData?.[0]) {
//         const row = feedbackData[0];
//         const latestDone = (callHistoryData || []).find(c => c.current_stage === "Conversation Done");
// const feedbackDate = latestDone?.followup_date || new Date().toISOString().split("T")[0];
// // then setClientFeedback({... , date: feedbackDate })

//         setClientFeedback({
//           isHappy: row.client_emotion === "happy",
//           rating: parseInt(String(row.rating || "0"), 10),
//           notes: row.notes || "",
//           willRenew: row.renew_status === "yes",
//     date: feedbackDate });
//       }
//     };

//     fetchCallHistoryAndFeedback();
//   }, [historyDialogOpen, selectedClient]);

//   // ---- derived views
//   const filteredClients = useMemo(() => {
//     const term = searchTerm.trim().toLowerCase();
//     const bySearch = (c: Client) =>
//       c.email.toLowerCase().includes(term) ||
//       c.client_name.toLowerCase().includes(term) ||
//       (c.phone ?? "").toString().toLowerCase().includes(term);

//     if (followUpFilter === "Today") {
//       const today = new Date();
//       return clients.filter((client) => {
//         const createdAt = new Date(client.created_at);
//         const diffInDays = Math.floor((today.getTime() - createdAt.getTime()) / 86400000);
//         return diffInDays === 15 && bySearch(client);
//       });
//     }
//     return clients.filter(bySearch);
//   }, [clients, searchTerm, followUpFilter]);

//   const sortedClients = useMemo(() => {
//     if (!sortKey) return filteredClients;
//     const arr = [...filteredClients];
//     if (sortKey === "created_at") {
//       arr.sort((a, b) => {
//         const da = new Date(a.created_at).getTime();
//         const db = new Date(b.created_at).getTime();
//         return sortOrder === "asc" ? da - db : db - da;
//       });
//     } else if (sortKey === "client_name") {
//       arr.sort((a, b) => {
//         const va = (a.client_name || "").toLowerCase();
//         const vb = (b.client_name || "").toLowerCase();
//         if (va === vb) return 0;
//         return sortOrder === "asc" ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
//       });
//     }
//     return arr;
//   }, [filteredClients, sortKey, sortOrder]);

//   const handleSort = (key: "client_name" | "created_at") => {
//     if (sortKey === key) {
//       setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
//     } else {
//       setSortKey(key);
//       setSortOrder("asc");
//     }
//   };

//   const getRenewWithinBadge = (createdAt: string): React.ReactNode => {
//     if (!createdAt) return "-";
//     const closedDate = new Date(createdAt);
//     const today = new Date();
//     const diffInDays = Math.floor((today.getTime() - closedDate.getTime()) / 86400000);
//     if (diffInDays < 15) {
//       const daysLeft = 15 - diffInDays;
//       return <Badge className="bg-green-100 text-green-800">Within {daysLeft} day{daysLeft === 1 ? "" : "s"}</Badge>;
//     } else if (diffInDays === 15) {
//       return <Badge className="bg-yellow-100 text-gray-800">Today lastdate</Badge>;
//     } else {
//       const overdueDays = diffInDays - 15;
//       return <Badge className="bg-red-100 text-red-800">Overdue by {overdueDays} day{overdueDays === 1 ? "" : "s"}</Badge>;
//     }
//   };

//   // ---- stage transitions
//   const handleStageUpdate = (clientId: string, newStage: AccountStage) => {
//     const current = clients.find((c) => c.id === clientId);
//     if (!current) return;
//     prevStageRef.current = current.stage;
//     changeCommittedRef.current = false;

//     // optimistic UI
//     setClients((prev) => prev.map((c) => (c.id === clientId ? { ...c, stage: newStage } : c)));

//     const clientWithUpdatedStage = { ...current, stage: newStage };
//     setSelectedClient(clientWithUpdatedStage);

//     if (newStage === "Conversation Done") {
//       setFeedbackForm({
//         isHappy: false,
//         rating: 5,
//         notes: "",
//         willRenew: false,
//         date: new Date().toISOString().split("T")[0],
//       });
//       setFeedbackDialogOpen(true);
//     } else {
//       setPendingStage(newStage);
//       setFollowUpForm({
//         date: new Date().toISOString().split("T")[0],
//         notes: "",
//       });
//       setFollowUpDialogOpen(true);
//     }
//   };

//   // Close handlers that can revert stage if user cancels
//   const onFollowUpDialogOpenChange = (open: boolean) => {
//     setFollowUpDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       // revert
//       setClients((prev) =>
//         prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c))
//       );
//       setPendingStage(null);
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };

//   const onFeedbackDialogOpenChange = (open: boolean) => {
//     setFeedbackDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       // revert
//       setClients((prev) =>
//         prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c))
//       );
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };

//   const handleFeedbackSubmit = async () => {
//     if (!selectedClient) {
//       alert("No client selected.");
//       return;
//     }
//     if (!feedbackForm.rating || feedbackForm.rating < 1 || feedbackForm.rating > 5) {
//       alert("Please select a valid rating between 1 and 5.");
//       return;
//     }
//     if (!feedbackForm.notes || feedbackForm.notes.trim() === "") {
//       alert("Please provide feedback notes.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse =
//       !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     // validate lead exists
//     const { data: leadCheck, error: leadCheckError } = await supabase
//       .from("leads")
//       .select("business_id")
//       .eq("business_id", selectedClient.id)
//       .limit(1);
//     if (leadCheckError || !leadCheck || leadCheck.length === 0) {
//       alert("Lead does not exist. Please create the lead first.");
//       return;
//     }

//     // 1) save feedback
//     const feedbackRow = {
//       lead_id: selectedClient.id,
//       client_emotion: feedbackForm.isHappy ? "happy" : "unhappy",
//       rating: feedbackForm.rating.toString(),
//       notes: feedbackForm.notes.trim(),
//       renew_status: feedbackForm.willRenew ? "yes" : "no",
//       email: emailToUse,
//     };
//     const { error: fbErr } = await supabase.from("client_feedback").insert([feedbackRow]);
//     if (fbErr) {
//       console.error("Error saving feedback:", fbErr);
//       alert(`Failed to save feedback: ${fbErr.message}`);
//       return;
//     }

//     // 2) persist stage in call_history so it survives reload
//     const { error: chErr } = await supabase.from("call_history").insert([
//       {
//         lead_id: selectedClient.id,
//         current_stage: "Conversation Done",
//         followup_date: feedbackForm.date, // when feedback captured
//         notes: `Feedback recorded: rating ${feedbackForm.rating}/5. ${feedbackForm.notes}`.slice(0, 1000),
//         assigned_to: selectedClient.assigned_to || "Unassigned",
//         email: emailToUse,
//         phone: phoneToUse,
//       },
//     ]);
//     if (chErr) {
//       console.error("Error writing call_history for Conversation Done:", chErr);
//       // Don‚Äôt block the UX; the feedback is saved. But stage may revert on hard refresh.
//     }

//     // update local state
//     setClients((prev) =>
//       prev.map((c) => (c.id === selectedClient.id ? { ...c, feedback: feedbackForm, stage: "Conversation Done" } : c))
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFeedbackDialogOpen(false);
//     setFeedbackForm({ isHappy: false, rating: 5, notes: "", willRenew: false, date: new Date().toISOString().split("T")[0] });
//   };

//   const handleFollowUpSave = async () => {
//     if (!selectedClient || !pendingStage) {
//       alert("No client or stage selected.");
//       return;
//     }
//     if (!followUpForm.date || !followUpForm.notes.trim()) {
//       alert("Please provide a follow-up date and notes.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse =
//       !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const followUpData = {
//       lead_id: selectedClient.id,
//       current_stage: pendingStage,
//       followup_date: followUpForm.date,
//       notes: followUpForm.notes.trim(),
//       assigned_to: selectedClient.assigned_to || "Unassigned",
//       email: emailToUse,
//       phone: phoneToUse,
//     };

//     const { error } = await supabase.from("call_history").insert([followUpData]);
//     if (error) {
//       console.error("Error saving follow-up:", error);
//       alert("Failed to save follow-up. Please try again.");
//       return;
//     }

//     // local update
//     setClients((prev) =>
//       prev.map((client) =>
//         client.id === selectedClient.id
//           ? {
//               ...client,
//               stage: pendingStage,
//               follow_ups: [...(client.follow_ups || []), { date: followUpForm.date, notes: followUpForm.notes }],
//             }
//           : client
//       )
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFollowUpDialogOpen(false);
//     setFollowUpForm({ date: "", notes: "" });
//     setPendingStage(null);
//   };

//   // ---- CSV
//   const handleCSVUpload = (file: File) => {
//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const requiredFields = [
//           "lead_id",
//           "Name",
//           "Rate",
//           "Payment Frequency",
//           "sale_done",
//           "Onboarded date",
//           "Phone number",
//           "email",
//         ];
//         const fields: string[] = Array.isArray(results.meta.fields) ? (results.meta.fields as string[]) : [];
//         const missingFields = requiredFields.filter((f) => !fields.includes(f));
//         if (missingFields.length > 0) {
//           alert(`Missing required columns: ${missingFields.join(", ")}`);
//           return;
//         }
//         setCsvData(results.data as any[]);
//       },
//       error: function (error) {
//         console.error("CSV parsing error:", error);
//         alert("Failed to parse CSV.");
//       },
//     });
//   };

//   const handleCSVSubmit = async () => {
//     if (csvData.length === 0) {
//       alert("No CSV data to submit");
//       return;
//     }

//     try {
//       const salesToInsert: any[] = [];

//       for (const row of csvData) {
//         const lead_id = row["lead_id"]?.trim?.();
//         const name = row["Name"]?.trim?.();
//         const email = row["email"]?.trim?.();
//         const sale_value = parseFloat(row["Rate"]);
//         const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//         const date = new Date(row["Onboarded date"]);
//         const sale_done = new Date(row["sale_done"]);

//         if (!lead_id || !name || !email || !sale_value || !subscription_cycle || isNaN(date.getTime()) || isNaN(sale_done.getTime())) {
//           console.warn("‚ùå Skipping invalid row:", row);
//           if (!lead_id) console.warn("‚õî Missing lead_id");
//           if (isNaN(date.getTime())) console.warn("‚õî Invalid Onboarded date:", row["Onboarded date"]);
//           if (isNaN(sale_done.getTime())) console.warn("‚õî Invalid sale_done date:", row["sale_done"]);
//           continue;
//         }

//         salesToInsert.push({
//           lead_id,
//           lead_name: name,
//           email,
//           sale_value,
//           subscription_cycle,
//           payment_mode: "UPI",
//           finance_status: "Paid",
//           closed_at: sale_done.toISOString(),
//           onboarded_date: date.toISOString().split("T")[0],
//         });
//       }

//       if (salesToInsert.length === 0) {
//         alert("No valid rows to upload.");
//         return;
//       }

//       const { error } = await supabase.from("sales_closure").insert(salesToInsert);
//       if (error) throw error;

//       alert(`üéâ Successfully inserted ${salesToInsert.length} renewal records into sales_closure`);
//       setUploadDialogOpen(false);
//       setCsvData([]);
//       setCsvFile(null);
//     } catch (err: any) {
//       console.error("‚ùå Upload failed:", err);
//       alert(`Upload failed: ${err?.message || String(err)}`);
//     }
//   };

//   // ---- dashboard aggregates (now work because we hydrate feedback at load)
//   const happyCount = useMemo(
//     () => clients.reduce((acc, c) => (c.feedback?.isHappy ? acc + 1 : acc), 0),
//     [clients]
//   );
//   const willRenewCount = useMemo(
//     () => clients.reduce((acc, c) => (c.feedback?.willRenew ? acc + 1 : acc), 0),
//     [clients]
//   );
//   const avgRating = useMemo(() => {
//     const fb = clients.map((c) => c.feedback).filter(Boolean) as Feedback[];
//     if (fb.length === 0) return "N/A";
//     const mean = fb.reduce((s, f) => s + (f.rating || 0), 0) / fb.length;
//     return mean.toFixed(1);
//   }, [clients]);

//   return (
//     <>
//       {pageLoading && <FullScreenLoader />}
//       <ProtectedRoute allowedRoles={["Account Management", "Super Admin"]}>
//         <DashboardLayout>
//           <div className="space-y-6">
//             <div className="flex justify-between items-center">
//               <div>
//                 <h1 className="text-3xl font-bold text-gray-900">Account Management CRM</h1>
//                 <p className="text-gray-600 mt-2">Manage client relationships and feedback</p>
//               </div>
//               <div className="flex justify-end mb-4">
//                 <Button onClick={() => setUploadDialogOpen(true)}>Upload Sale Done CSV</Button>
//               </div>
//             </div>

//             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Happy Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{happyCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Renewal Intent</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{willRenewCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Avg Rating</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{avgRating}</div>
//                 </CardContent>
//               </Card>
//             </div>

//             <Card>
//               <CardHeader>
//                 <CardTitle>Account Management Dashboard</CardTitle>
//                 <CardDescription>Manage client accounts and track feedback</CardDescription>
//               </CardHeader>
//               <CardContent>
//                 <div className="flex items-center justify-between mt-4">
//                   <Input
//                     placeholder="Search by email, name, or phone"
//                     value={searchTerm}
//                     onChange={(e) => setSearchTerm(e.target.value)}
//                     className="max-w-md"
//                   />

//                   <Select value={followUpFilter} onValueChange={(v) => setFollowUpFilter(v as "All dates" | "Today")}>
//                     <SelectTrigger className="w-40">
//                       <SelectValue placeholder="Follow Up" />
//                     </SelectTrigger>
//                     <SelectContent>
//                       <SelectItem value="All dates">All dates</SelectItem>
//                       <SelectItem value="Today">Due today (15th day)</SelectItem>
//                     </SelectContent>
//                   </Select>
//                 </div>

//                 <div className="rounded-md border mt-6">
//                   <Table>
//                     <TableHeader>
//                       <TableRow>
//                         <TableHead>S.No</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Client Name</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("desc");
//                               }}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Email</TableHead>
//                         <TableHead>Phone</TableHead>
//                         <TableHead>Assigned To</TableHead>
//                         <TableHead>Stage</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Closed At</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => handleSort("created_at")}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("created_at");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Deadline</TableHead>
//                         <TableHead>Actions</TableHead>
//                       </TableRow>
//                     </TableHeader>
//                     <TableBody>
//                       {sortedClients.map((client, idx) => (
//                         <TableRow key={`${client.id}-${idx}`}>
//                           <TableCell>{idx + 1}</TableCell>

//                           <TableCell
//                             className="font-medium max-w-[180px] break-words whitespace-normal cursor-pointer text-blue-600 hover:underline"
//                             onClick={() => window.open(`/leads/${client.id}`, "_blank")}
//                           >
//                             {client.client_name}
//                           </TableCell>

//                           <TableCell className="max-w-[220px] break-words whitespace-normal">{client.email}</TableCell>
//                           <TableCell>{client.phone || "-"}</TableCell>
//                           <TableCell>{client.assigned_to}</TableCell>

//                           <TableCell>
//                             <Select
//                               value={accountStages.includes(client.stage) ? client.stage : undefined}
//                               onValueChange={(value: AccountStage) => handleStageUpdate(client.id, value)}
//                             >
//                               <SelectTrigger className="w-44">
//                                 <SelectValue placeholder="Select Stage" />
//                               </SelectTrigger>
//                               <SelectContent>
//                                 {accountStages.map((stage) => (
//                                   <SelectItem key={stage} value={stage}>
//                                     <span className={`inline-flex px-2 py-1 rounded ${getStageColor(stage)}`}>{stage}</span>
//                                   </SelectItem>
//                                 ))}
//                               </SelectContent>
//                             </Select>
//                           </TableCell>

//                           <TableCell>{formatDate(client.created_at)}</TableCell>
//                           <TableCell>{getRenewWithinBadge(client.created_at)}</TableCell>

//                           <TableCell>
//                             <div className="flex gap-2">
//                               <Button
//                                 size="sm"
//                                 variant="outline"
//                                 onClick={() => {
//                                   setSelectedClient(client);
//                                   setHistoryDialogOpen(true);
//                                 }}
//                                 aria-label="View history"
//                                 title="View history"
//                               >
//                                 <Eye className="h-4 w-4" />
//                               </Button>
//                               <Button
//                                 size="sm"
//                                 variant="outline"
//                                 onClick={() => {
//                                   setSelectedClient(client);
//                                   if (client.feedback) setFeedbackForm(client.feedback);
//                                   setFeedbackDialogOpen(true);
//                                   prevStageRef.current = client.stage; // allow revert if canceled
//                                 }}
//                                 aria-label="Add feedback"
//                                 title="Add feedback"
//                               >
//                                 <MessageSquare className="h-4 w-4" />
//                               </Button>
//                             </div>
//                           </TableCell>
//                         </TableRow>
//                       ))}
//                     </TableBody>
//                   </Table>
//                 </div>
//               </CardContent>
//             </Card>

//             {/* HISTORY DIALOG */}
//             <Dialog open={historyDialogOpen} onOpenChange={setHistoryDialogOpen}>
//               <DialogContent className="max-w-2xl">
//                 <DialogHeader>
//                   <DialogTitle>{selectedClient?.client_name} - Full History</DialogTitle>
//                   <DialogDescription>Complete follow-up history and client interactions</DialogDescription>
//                 </DialogHeader>

//                 {selectedClient && (
//                   <div className="space-y-6">
//                     <div className="grid grid-cols-2 gap-4">
//                       <div>
//                         <Label className="text-sm font-medium">Email</Label>
//                         <p className="text-sm text-gray-600 break-words">{selectedClient.email}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Assigned To</Label>
//                         <p className="text-sm text-gray-600">{selectedClient.assigned_to}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Current Stage</Label>
//                         <Badge className={getStageColor(selectedClient.stage)}>{selectedClient.stage}</Badge>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Closed</Label>
//                         <p className="text-sm text-gray-600">{formatDate(selectedClient.created_at)}</p>
//                       </div>
//                     </div>

//                     <div>
//                       <Label className="text-sm font-medium mb-3 block">Follow-up History</Label>
//                       <div className="space-y-3 max-h-64 overflow-y-auto">
//                         {callHistory.length > 0 ? (
//                           callHistory.map((entry, index) => (
//                             <div key={index} className="p-3 bg-gray-50 rounded-lg">
//                               <div className="flex items-center gap-2 mb-2">
//                                 <Calendar className="h-4 w-4 text-gray-500" />
//                                 <span className="text-sm font-medium">
//                                   {entry.followup_date || (entry.followup_date ? String(entry.followup_date).split("T")[0] : "")}
//                                 </span>
//                               </div>
//                               <div className="mb-2">
//                                 <span className="text-sm font-medium">Stage: </span>
//                                 <Badge className={getStageColor(entry.current_stage)}>{entry.current_stage}</Badge>
//                               </div>
//                               <p className="text-sm text-gray-600 whitespace-pre-wrap">{entry.notes}</p>
//                             </div>
//                           ))
//                         ) : (
//                           <p className="text-sm text-gray-600">No follow-up history available.</p>
//                         )}
//                       </div>
//                     </div>

//                     {clientFeedback && (
//                       <div>
//                         <Label className="text-sm font-medium mb-3 block">Latest Feedback</Label>
//                         <div className="p-3 bg-blue-50 rounded-lg space-y-2">
//                           <div className="flex items-center justify-between">
//                             <div className="flex items-center gap-2">
//                               <span className="text-sm font-medium">Rating:</span>
//                               <div className="flex">{renderStars(clientFeedback.rating)}</div>
//                             </div>
//                             <Badge variant={clientFeedback.isHappy ? "default" : "secondary"}>
//                               {clientFeedback.isHappy ? "Happy" : "Needs Attention"}
//                             </Badge>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Will Renew: </span>
//                             <span className={`text-sm ${clientFeedback.willRenew ? "text-green-600" : "text-red-600"}`}>
//                               {clientFeedback.willRenew ? "Yes" : "No"}
//                             </span>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Notes: </span>
//                             <p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">{clientFeedback.notes}</p>
//                           </div>
//                           <div className="text-xs text-gray-500">Feedback Date: {clientFeedback.date}</div>
//                         </div>
//                       </div>
//                     )}
//                   </div>
//                 )}
//               </DialogContent>
//             </Dialog>

//             {/* FEEDBACK DIALOG */}
//             <Dialog open={feedbackDialogOpen} onOpenChange={onFeedbackDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Client Feedback</DialogTitle>
//                   <DialogDescription>Collect feedback from {selectedClient?.client_name}</DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Is Client Happy?</Label>
//                     <Select
//                       value={feedbackForm.isHappy ? "happy" : "unhappy"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, isHappy: value === "happy" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="happy">Happy</SelectItem>
//                         <SelectItem value="unhappy">Unhappy</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Rating (1-5)</Label>
//                     <Select
//                       value={String(feedbackForm.rating)}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, rating: Number(value) }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         {[1, 2, 3, 4, 5].map((rating) => (
//                           <SelectItem key={rating} value={String(rating)}>
//                             <div className="flex items-center gap-2">
//                               <span>{rating}</span>
//                               <div className="flex">{renderStars(rating)}</div>
//                             </div>
//                           </SelectItem>
//                         ))}
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label>Notes</Label>
//                     <Textarea
//                       placeholder="Enter detailed feedback..."
//                       value={feedbackForm.notes}
//                       onChange={(e) => setFeedbackForm((prev) => ({ ...prev, notes: e.target.value }))}
//                     />
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Will Client Renew?</Label>
//                     <Select
//                       value={feedbackForm.willRenew ? "yes" : "no"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, willRenew: value === "yes" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="yes">Yes</SelectItem>
//                         <SelectItem value="no">No</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFeedbackDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFeedbackSubmit}>Save Feedback</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* FOLLOW-UP DIALOG */}
//             <Dialog open={followUpDialogOpen} onOpenChange={onFollowUpDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Schedule Follow-up</DialogTitle>
//                 </DialogHeader>
//                 <div className="space-y-4">
//                   <div>
//                     <Label className="block mb-1">Follow-up Date</Label>
//                     <Input
//                       type="date"
//                       value={followUpForm.date}
//                       onChange={(e) => setFollowUpForm((f) => ({ ...f, date: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                   <div>
//                     <Label className="block mb-1">Notes</Label>
//                     <Textarea
//                       placeholder="Add notes..."
//                       value={followUpForm.notes}
//                       onChange={(e) => setFollowUpForm((f) => ({ ...f, notes: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                 </div>
//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFollowUpDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFollowUpSave}>Save Follow-up</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* CSV UPLOAD */}
//             <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>
//               <DialogContent className="max-w-5xl">
//                 <DialogHeader>
//                   <DialogTitle>Upload Sale Done CSV</DialogTitle>
//                   <DialogDescription>
//                     Upload your sales CSV. We'll parse and show the number of entries.
//                     <br />
//                     Required columns:
//                     <br />
//                     <code>lead_id, Name, Rate, Payment Frequency, sale_done, Onboarded date, Phone number, email</code>
//                     <br />
//                     Dates must be <code>yyyy-mm-dd</code>.
//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Input
//                     type="file"
//                     accept=".csv"
//                     onChange={(e) => {
//                       const file = e.target.files?.[0];
//                       if (file) {
//                         setCsvFile(file);
//                         handleCSVUpload(file);
//                       }
//                     }}
//                   />
//                   <p className="text-sm text-gray-600">
//                     {csvData.length > 0 ? `‚úÖ Detected ${csvData.length} records in file.` : "No file parsed yet."}
//                   </p>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setUploadDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleCSVSubmit} disabled={csvData.length === 0}>
//                     Submit to Supabase
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>
//           </div>
//         </DashboardLayout>
//       </ProtectedRoute>
//     </>
//   );
// }



// // app/account-management/page.tsx
// "use client";

// import * as React from "react";
// import { useEffect, useMemo, useRef, useState } from "react";
// import { supabase } from "@/utils/supabase/client";
// import { DashboardLayout } from "@/components/layout/dashboard-layout";
// import { Button } from "@/components/ui/button";
// import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
// import { Badge } from "@/components/ui/badge";
// import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
// import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
// import { Input } from "@/components/ui/input";
// import { Label } from "@/components/ui/label";
// import { Textarea } from "@/components/ui/textarea";
// import { Eye, MessageSquare, Star, Calendar } from "lucide-react";
// import ProtectedRoute from "@/components/auth/ProtectedRoute";
// import Papa from "papaparse";
// import FullScreenLoader from "@/components/ui/FullScreenLoader";

// /** =========================
//  *  Config ‚Äî where to store assignment in sales_closure
//  *  Flip these 2 constants if you created the new columns:
//  *    ACCOUNT_EMAIL_COL = "account_assigned_email";
//  *    ACCOUNT_NAME_COL  = "account_assigned_name";
//  *  ========================= */
// const ACCOUNT_EMAIL_COL = "account_assigned_email";
// const ACCOUNT_NAME_COL  = "account_assigned_name";

// type AccountStage = "DNP" | "Call Again" | "Conversation Done";

// interface FollowUp {
//   date: string;
//   notes: string;
// }

// interface Feedback {
//   isHappy: boolean;
//   rating: number;
//   notes: string;
//   willRenew: boolean;
//   date: string; // yyyy-mm-dd
// }

// interface Client {
//   id: string;
//   client_name: string;
//   email: string;
//   phone?: string | null;
//   assigned_to: string;
//   stage: AccountStage;
//   created_at: string; // ISO or yyyy-mm-dd
//   follow_ups?: FollowUp[];
//   feedback?: Feedback;
// }

// const accountStages: AccountStage[] = ["DNP", "Call Again", "Conversation Done"];

// const getStageColor = (stage: AccountStage) => {
//   switch (stage) {
//     case "DNP":
//       return "bg-yellow-100 text-yellow-800";
//     case "Call Again":
//       return "bg-blue-100 text-blue-800";
//     case "Conversation Done":
//       return "bg-green-100 text-green-800";
//     default:
//       return "bg-gray-100 text-gray-800";
//   }
// };

// const formatDate = (dateString: string | undefined): string => {
//   if (!dateString) return "N/A";
//   const d = new Date(dateString);
//   return isNaN(d.getTime()) ? "N/A" : d.toLocaleDateString();
// };

// function renderStars(rating: number) {
//   return (
//     <span className="flex">
//       {Array.from({ length: 5 }, (_, i) => (
//         <Star
//           key={i}
//           className={`h-4 w-4 ${i < rating ? "fill-current text-yellow-400" : "text-gray-300"}`}
//         />
//       ))}
//     </span>
//   );
// }

// export default function AccountManagementPage() {
//   const [clients, setClients] = useState<Client[]>([]);
//   const [pageLoading, setPageLoading] = useState(false);

//   const [selectedClient, setSelectedClient] = useState<Client | null>(null);
//   const [historyDialogOpen, setHistoryDialogOpen] = useState(false);
//   const [feedbackDialogOpen, setFeedbackDialogOpen] = useState(false);
//   const [followUpDialogOpen, setFollowUpDialogOpen] = useState(false);

//   const [searchTerm, setSearchTerm] = useState("");
//   const [followUpFilter, setFollowUpFilter] = useState<"All dates" | "Today">("All dates");
//   const [sortKey, setSortKey] = useState<"client_name" | "created_at" | null>(null);
//   const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc");

//   const [feedbackForm, setFeedbackForm] = useState<Feedback>({
//     isHappy: false,
//     rating: 5,
//     notes: "",
//     willRenew: false,
//     date: new Date().toISOString().split("T")[0],
//   });
//   const [followUpForm, setFollowUpForm] = useState<FollowUp>({ date: "", notes: "" });

//   const [pendingStage, setPendingStage] = useState<AccountStage | null>(null);
//   const prevStageRef = useRef<AccountStage | null>(null);
//   const changeCommittedRef = useRef<boolean>(false);

//   const [callHistory, setCallHistory] = useState<any[]>([]);
//   const [clientFeedback, setClientFeedback] = useState<Feedback | null>(null);

//   const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
//   const [csvFile, setCsvFile] = useState<File | null>(null);
//   const [csvData, setCsvData] = useState<any[]>([]);

//   /** NEW: bulk selection + assignment state */
//   const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
//   const [bulkDialogOpen, setBulkDialogOpen] = useState(false);
//   const [associates, setAssociates] = useState<{ name: string; email: string }[]>([]);
//   const [selectedAssociateEmail, setSelectedAssociateEmail] = useState<string>("");

//   /** ===== Initial load ===== */
//   useEffect(() => {
//     let cancelled = false;

//     const fetchClients = async () => {
//       setPageLoading(true);
//       try {
//         const { data: rawSalesData, error: salesError } = await supabase
//           .from("sales_closure")
//           .select("lead_id, email, onboarded_date")
//           .not("onboarded_date", "is", null)
//           .order("onboarded_date", { ascending: false });

//         if (salesError || !rawSalesData) {
//           console.error("‚ùå sales_closure fetch failed", salesError);
//           return;
//         }

//         const salesDataMap = new Map<string, { lead_id: string; email: string; onboarded_date: string }>();
//         for (const row of rawSalesData) {
//           if (!salesDataMap.has(row.lead_id)) salesDataMap.set(row.lead_id, row);
//         }
//         const salesData = Array.from(salesDataMap.values());
//         const leadIds = salesData.map((s) => s.lead_id);

//         const { data: leadsData, error: leadsError } = await supabase
//           .from("leads")
//           .select("business_id, name, phone, assigned_to, email")
//           .in("business_id", leadIds);

//         if (leadsError || !leadsData) {
//           console.error("‚ùå leads fetch failed", leadsError);
//           return;
//         }
//         const leadsMap = Object.fromEntries(leadsData.map((l) => [l.business_id, l]));

//         const { data: callRaw, error: callError } = await supabase
//           .from("call_history")
//           .select("lead_id, current_stage, followup_date")
//           .order("followup_date", { ascending: false });

//         if (callError) console.error("‚ùå call_history fetch failed", callError);

//         const latestCallMap: Record<string, any> = {};
//         for (const call of callRaw || []) {
//           if (!latestCallMap[call.lead_id]) latestCallMap[call.lead_id] = call;
//         }

//         const { data: feedbackRows, error: fbErr } = await supabase
//           .from("client_feedback")
//           .select("lead_id, client_emotion, rating, notes, renew_status, id")
//           .in("lead_id", leadIds)
//           .order("id", { ascending: false });

//         if (fbErr) console.error("‚ö†Ô∏è client_feedback fetch failed", fbErr);

//         const latestFbMap = new Map<string, Feedback>();
//         for (const r of feedbackRows || []) {
//           if (!latestFbMap.has(r.lead_id)) {
//             latestFbMap.set(r.lead_id, {
//               isHappy: r.client_emotion === "happy",
//               rating: parseInt(String(r.rating || "0"), 10),
//               notes: r.notes || "",
//               willRenew: r.renew_status === "yes",
//               date: new Date().toISOString().split("T")[0],
//             });
//           }
//         }

//         const mergedClients: Client[] = salesData.map((sale) => {
//           const lead = leadsMap[sale.lead_id] || {};
//           const call = latestCallMap[sale.lead_id];
//           return {
//             id: sale.lead_id,
//             client_name: lead.name || "Unnamed",
//             email: sale.email || lead.email || "unknown@example.com",
//             phone: lead.phone ?? null,
//             assigned_to: lead.assigned_to || "Unassigned",
//             created_at: sale.onboarded_date,
//             stage: (call?.current_stage as AccountStage) || "DNP",
//             follow_ups: [],
//             feedback: latestFbMap.get(sale.lead_id),
//           };
//         });

//         if (!cancelled) setClients(mergedClients);
//       } catch (err) {
//         console.error("‚ùå Unexpected error:", err);
//       } finally {
//         if (!cancelled) setPageLoading(false);
//       }
//     };

//     fetchClients();
//     return () => {
//       cancelled = true;
//     };
//   }, []);

//   /** ===== History & feedback fetch for selected client ===== */
//   useEffect(() => {
//     if (!historyDialogOpen || !selectedClient) {
//       setCallHistory([]);
//       setClientFeedback(null);
//       return;
//     }

//     const fetchCallHistoryAndFeedback = async () => {
//       const { data: callHistoryData, error: callHistoryError } = await supabase
//         .from("call_history")
//         .select("current_stage, followup_date, notes")
//         .eq("lead_id", selectedClient.id)
//         .order("followup_date", { ascending: false });

//       if (callHistoryError) {
//         console.error(`Error fetching call history for lead ${selectedClient.id}:`, JSON.stringify(callHistoryError, null, 2));
//       } else {
//         setCallHistory(callHistoryData || []);
//       }

//       const { data: feedbackData, error: feedbackError } = await supabase
//         .from("client_feedback")
//         .select("client_emotion, rating, notes, renew_status, id")
//         .eq("lead_id", selectedClient.id)
//         .order("id", { ascending: false })
//         .limit(1);

//       if (feedbackError) {
//         console.error(`Error fetching client feedback for lead ${selectedClient.id}:`, JSON.stringify(feedbackError, null, 2));
//       } else if (feedbackData?.[0]) {
//         const row = feedbackData[0];
//         setClientFeedback({
//           isHappy: row.client_emotion === "happy",
//           rating: parseInt(String(row.rating || "0"), 10),
//           notes: row.notes || "",
//           willRenew: row.renew_status === "yes",
//           date: new Date().toISOString().split("T")[0],
//         });
//       }
//     };

//     fetchCallHistoryAndFeedback();
//   }, [historyDialogOpen, selectedClient]);

//   /** ===== Derived views (filter/sort) ===== */
//   const filteredClients = useMemo(() => {
//     const term = searchTerm.trim().toLowerCase();
//     const bySearch = (c: Client) =>
//       c.email.toLowerCase().includes(term) ||
//       c.client_name.toLowerCase().includes(term) ||
//       (c.phone ?? "").toString().toLowerCase().includes(term);

//     if (followUpFilter === "Today") {
//       const today = new Date();
//       return clients.filter((client) => {
//         const createdAt = new Date(client.created_at);
//         const diffInDays = Math.floor((today.getTime() - createdAt.getTime()) / 86400000);
//         return diffInDays === 15 && bySearch(client);
//       });
//     }
//     return clients.filter(bySearch);
//   }, [clients, searchTerm, followUpFilter]);

//   const sortedClients = useMemo(() => {
//     if (!sortKey) return filteredClients;
//     const arr = [...filteredClients];
//     if (sortKey === "created_at") {
//       arr.sort((a, b) => {
//         const da = new Date(a.created_at).getTime();
//         const db = new Date(b.created_at).getTime();
//         return sortOrder === "asc" ? da - db : db - da;
//       });
//     } else if (sortKey === "client_name") {
//       arr.sort((a, b) => {
//         const va = (a.client_name || "").toLowerCase();
//         const vb = (b.client_name || "").toLowerCase();
//         if (va === vb) return 0;
//         return sortOrder === "asc" ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
//       });
//     }
//     return arr;
//   }, [filteredClients, sortKey, sortOrder]);

//   /** ===== Sorting handlers ===== */
//   const handleSort = (key: "client_name" | "created_at") => {
//     if (sortKey === key) {
//       setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
//     } else {
//       setSortKey(key);
//       setSortOrder("asc");
//     }
//   };

//   /** ===== Deadline badge ===== */
//   const getRenewWithinBadge = (createdAt: string): React.ReactNode => {
//     if (!createdAt) return "-";
//     const closedDate = new Date(createdAt);
//     const today = new Date();
//     const diffInDays = Math.floor((today.getTime() - closedDate.getTime()) / 86400000);
//     if (diffInDays < 15) {
//       const daysLeft = 15 - diffInDays;
//       return <Badge className="bg-green-100 text-green-800">Within {daysLeft} day{daysLeft === 1 ? "" : "s"}</Badge>;
//     } else if (diffInDays === 15) {
//       return <Badge className="bg-yellow-100 text-gray-800">Today lastdate</Badge>;
//     } else {
//       const overdueDays = diffInDays - 15;
//       return <Badge className="bg-red-100 text-red-800">Overdue by {overdueDays} day{overdueDays === 1 ? "" : "s"}</Badge>;
//     }
//   };

//   /** ===== Stage transitions (unchanged) ===== */
//   const handleStageUpdate = (clientId: string, newStage: AccountStage) => {
//     const current = clients.find((c) => c.id === clientId);
//     if (!current) return;
//     prevStageRef.current = current.stage;
//     changeCommittedRef.current = false;

//     setClients((prev) => prev.map((c) => (c.id === clientId ? { ...c, stage: newStage } : c)));
//     const clientWithUpdatedStage = { ...current, stage: newStage };
//     setSelectedClient(clientWithUpdatedStage);

//     if (newStage === "Conversation Done") {
//       setFeedbackForm({
//         isHappy: false,
//         rating: 5,
//         notes: "",
//         willRenew: false,
//         date: new Date().toISOString().split("T")[0],
//       });
//       setFeedbackDialogOpen(true);
//     } else {
//       setPendingStage(newStage);
//       setFollowUpForm({
//         date: new Date().toISOString().split("T")[0],
//         notes: "",
//       });
//       setFollowUpDialogOpen(true);
//     }
//   };
//   const onFollowUpDialogOpenChange = (open: boolean) => {
//     setFollowUpDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       setClients((prev) => prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c)));
//       setPendingStage(null);
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };
//   const onFeedbackDialogOpenChange = (open: boolean) => {
//     setFeedbackDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       setClients((prev) => prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c)));
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };

//   const handleFeedbackSubmit = async () => {
//     if (!selectedClient) {
//       alert("No client selected.");
//       return;
//     }
//     if (!feedbackForm.rating || feedbackForm.rating < 1 || feedbackForm.rating > 5) {
//       alert("Please select a valid rating between 1 and 5.");
//       return;
//     }
//     if (!feedbackForm.notes || feedbackForm.notes.trim() === "") {
//       alert("Please provide feedback notes.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse =
//       !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const { data: leadCheck, error: leadCheckError } = await supabase
//       .from("leads")
//       .select("business_id")
//       .eq("business_id", selectedClient.id)
//       .limit(1);
//     if (leadCheckError || !leadCheck || leadCheck.length === 0) {
//       alert("Lead does not exist. Please create the lead first.");
//       return;
//     }

//     const feedbackRow = {
//       lead_id: selectedClient.id,
//       client_emotion: feedbackForm.isHappy ? "happy" : "unhappy",
//       rating: feedbackForm.rating.toString(),
//       notes: feedbackForm.notes.trim(),
//       renew_status: feedbackForm.willRenew ? "yes" : "no",
//       email: emailToUse,
//     };
//     const { error: fbErr } = await supabase.from("client_feedback").insert([feedbackRow]);
//     if (fbErr) {
//       console.error("Error saving feedback:", fbErr);
//       alert(`Failed to save feedback: ${fbErr.message}`);
//       return;
//     }

//     const { error: chErr } = await supabase.from("call_history").insert([
//       {
//         lead_id: selectedClient.id,
//         current_stage: "Conversation Done",
//         followup_date: feedbackForm.date,
//         notes: `Feedback recorded: rating ${feedbackForm.rating}/5. ${feedbackForm.notes}`.slice(0, 1000),
//         assigned_to: selectedClient.assigned_to || "Unassigned",
//         email: emailToUse,
//         phone: phoneToUse,
//       },
//     ]);
//     if (chErr) console.error("Error writing call_history for Conversation Done:", chErr);

//     setClients((prev) =>
//       prev.map((c) => (c.id === selectedClient.id ? { ...c, feedback: feedbackForm, stage: "Conversation Done" } : c))
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFeedbackDialogOpen(false);
//     setFeedbackForm({ isHappy: false, rating: 5, notes: "", willRenew: false, date: new Date().toISOString().split("T")[0] });
//   };

//   const handleFollowUpSave = async () => {
//     if (!selectedClient || !pendingStage) {
//       alert("No client or stage selected.");
//       return;
//     }
//     if (!followUpForm.date || !followUpForm.notes.trim()) {
//       alert("Please provide a follow-up date and notes.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse =
//       !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const followUpData = {
//       lead_id: selectedClient.id,
//       current_stage: pendingStage,
//       followup_date: followUpForm.date,
//       notes: followUpForm.notes.trim(),
//       assigned_to: selectedClient.assigned_to || "Unassigned",
//       email: emailToUse,
//       phone: phoneToUse,
//     };

//     const { error } = await supabase.from("call_history").insert([followUpData]);
//     if (error) {
//       console.error("Error saving follow-up:", error);
//       alert("Failed to save follow-up. Please try again.");
//       return;
//     }

//     setClients((prev) =>
//       prev.map((client) =>
//         client.id === selectedClient.id
//           ? {
//               ...client,
//               stage: pendingStage,
//               follow_ups: [...(client.follow_ups || []), { date: followUpForm.date, notes: followUpForm.notes }],
//             }
//           : client
//       )
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFollowUpDialogOpen(false);
//     setFollowUpForm({ date: "", notes: "" });
//     setPendingStage(null);
//   };

//   /** ===== CSV upload (unchanged core) ===== */
//   const handleCSVUpload = (file: File) => {
//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const requiredFields = [
//           "lead_id",
//           "Name",
//           "Rate",
//           "Payment Frequency",
//           "sale_done",
//           "Onboarded date",
//           "Phone number",
//           "email",
//         ];
//         const fields: string[] = Array.isArray(results.meta.fields) ? (results.meta.fields as string[]) : [];
//         const missingFields = requiredFields.filter((f) => !fields.includes(f));
//         if (missingFields.length > 0) {
//           alert(`Missing required columns: ${missingFields.join(", ")}`);
//           return;
//         }
//         setCsvData(results.data as any[]);
//       },
//       error: function (error) {
//         console.error("CSV parsing error:", error);
//         alert("Failed to parse CSV.");
//       },
//     });
//   };

//   const handleCSVSubmit = async () => {
//     if (csvData.length === 0) {
//       alert("No CSV data to submit");
//       return;
//     }

//     try {
//       const salesToInsert: any[] = [];

//       for (const row of csvData) {
//         const lead_id = row["lead_id"]?.trim?.();
//         const name = row["Name"]?.trim?.();
//         const email = row["email"]?.trim?.();
//         const sale_value = parseFloat(row["Rate"]);
//         const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//         const date = new Date(row["Onboarded date"]);
//         const sale_done = new Date(row["sale_done"]);

//         if (!lead_id || !name || !email || !sale_value || !subscription_cycle || isNaN(date.getTime()) || isNaN(sale_done.getTime())) {
//           console.warn("‚ùå Skipping invalid row:", row);
//           continue;
//         }

//         salesToInsert.push({
//           lead_id,
//           lead_name: name,
//           email,
//           sale_value,
//           subscription_cycle,
//           payment_mode: "UPI",
//           finance_status: "Paid",
//           closed_at: sale_done.toISOString(),
//           onboarded_date: date.toISOString().split("T")[0],
//         });
//       }

//       if (salesToInsert.length === 0) {
//         alert("No valid rows to upload.");
//         return;
//       }

//       const { error } = await supabase.from("sales_closure").insert(salesToInsert);
//       if (error) throw error;

//       alert(`üéâ Successfully inserted ${salesToInsert.length} renewal records into sales_closure`);
//       setUploadDialogOpen(false);
//       setCsvData([]);
//       setCsvFile(null);
//     } catch (err: any) {
//       console.error("‚ùå Upload failed:", err);
//       alert(`Upload failed: ${err?.message || String(err)}`);
//     }
//   };

//   /** ===== Dashboard aggregates ===== */
//   const happyCount = useMemo(
//     () => clients.reduce((acc, c) => (c.feedback?.isHappy ? acc + 1 : acc), 0),
//     [clients]
//   );
//   const willRenewCount = useMemo(
//     () => clients.reduce((acc, c) => (c.feedback?.willRenew ? acc + 1 : acc), 0),
//     [clients]
//   );
//   const avgRating = useMemo(() => {
//     const fb = clients.map((c) => c.feedback).filter(Boolean) as Feedback[];
//     if (fb.length === 0) return "N/A";
//     const mean = fb.reduce((s, f) => s + (f.rating || 0), 0) / fb.length;
//     return mean.toFixed(1);
//   }, [clients]);

//   /** ===== Bulk: helpers ===== */
//   const toggleOne = (id: string) => {
//     setSelectedIds((prev) => {
//       const next = new Set(prev);
//       if (next.has(id)) next.delete(id);
//       else next.add(id);
//       return next;
//     });
//   };

//   const quickSelect = (n: number) => {
//     const firstN = sortedClients.slice(0, n).map((c) => c.id);
//     setSelectedIds(new Set(firstN));
//   };

//   const clearSelection = () => setSelectedIds(new Set());

//   const openBulkDialog = async () => {
//     if (selectedIds.size === 0) return;
//     setBulkDialogOpen(true);
//     // fetch Accounts Associates
//     const { data, error } = await supabase
//       .from("profiles")
//       .select("full_name, user_email, roles")
//       .eq("roles", "Accounts Associate")
//       .not("user_email", "is", null);
//     if (error) {
//       console.error("Failed to load Accounts Associates:", error);
//       return;
//     }
//     setAssociates(
//       (data || [])
//         .filter((r) => r.user_email)
//         .map((r) => ({ name: r.full_name, email: r.user_email }))
//     );
//   };

//   const doBulkAssign = async () => {
//     if (!selectedAssociateEmail) {
//       alert("Choose an Accounts Associate.");
//       return;
//     }
//     const picked = associates.find((a) => a.email === selectedAssociateEmail);
//     if (!picked) {
//       alert("Invalid associate.");
//       return;
//     }
//     const leadIds = Array.from(selectedIds);
//     if (leadIds.length === 0) return;

//     // Update sales_closure: set account assignment email/name for all selected leads
//     const payload: Record<string, any> = {};
//     payload[ACCOUNT_EMAIL_COL] = picked.email;
//     payload[ACCOUNT_NAME_COL] = picked.name;

//     const { error } = await supabase
//       .from("sales_closure")
//       .update(payload)
//       .in("lead_id", leadIds);

//     if (error) {
//       console.error("Bulk assign failed:", error);
//       alert("Bulk assign failed. Check permissions/RLS.");
//       return;
//     }

//     // Update local UI (Assigned To column)
//     setClients((prev) =>
//       prev.map((c) => (selectedIds.has(c.id) ? { ...c, assigned_to: picked.name } : c))
//     );

//     setBulkDialogOpen(false);
//     setSelectedAssociateEmail("");
//     clearSelection();
//   };

//   return (
//     <>
//       {pageLoading && <FullScreenLoader />}
//       <ProtectedRoute allowedRoles={["Account Management", "Super Admin"]}>
//         <DashboardLayout>
//           <div className="space-y-6">
//             <div className="flex justify-between items-center">
//               <div>
//                 <h1 className="text-3xl font-bold text-gray-900">Account Management CRM</h1>
//                 <p className="text-gray-600 mt-2">Manage client relationships and feedback</p>
//               </div>
//               <div className="flex items-center gap-2">
               
//                 <Button onClick={() => setUploadDialogOpen(true)}>Upload Sale Done CSV</Button>
//               </div>
//             </div>

//             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Happy Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{happyCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Renewal Intent</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{willRenewCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Avg Rating</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{avgRating}</div>
//                 </CardContent>
//               </Card>
//             </div>

//             <Card>
//               <CardHeader>
//                 <CardTitle>Account Management Dashboard</CardTitle>
//                 <CardDescription>Manage client accounts and track feedback</CardDescription>
//               </CardHeader>
//               <CardContent>
//                 <div className="flex items-center justify-between mt-4">
//                   <Input
//                     placeholder="Search by email, name, or phone"
//                     value={searchTerm}
//                     onChange={(e) => setSearchTerm(e.target.value)}
//                     className="max-w-md"
//                   />

//                    <div className="flex justify-between items-center">
            
//               <div className="flex items-center gap-2">
//                 {/* Quick select chips */}
//                 <div className="hidden md:flex items-center gap-2 mr-2">
//                   <span className="text-sm text-gray-600">Select first:</span>
//                   {[10, 20, 40, 50].map((n) => (
//                     <Button key={n} size="sm" variant="outline" onClick={() => quickSelect(n)}>
//                       {n}
//                     </Button>
//                   ))}
//                   <Button size="sm" variant="ghost" onClick={clearSelection}>
//                     Clear
//                   </Button>
//                 </div>

//                 <Button
//                   variant="default"
//                   disabled={selectedIds.size === 0}
//                   onClick={openBulkDialog}
//                   title={selectedIds.size ? `Bulk assign ${selectedIds.size} selected` : "Select rows first"}
//                 >
//                   Bulk Assign
//                 </Button>


//                   <Select value={followUpFilter} onValueChange={(v) => setFollowUpFilter(v as "All dates" | "Today")}>
//                     <SelectTrigger className="w-40">
//                       <SelectValue placeholder="Follow Up" />
//                     </SelectTrigger>
//                     <SelectContent>
//                       <SelectItem value="All dates">All dates</SelectItem>
//                       <SelectItem value="Today">Due today (15th day)</SelectItem>
//                     </SelectContent>
//                   </Select>
//                   </div></div>
//                 </div>

//                 <div className="rounded-md border mt-6">
//                   <Table>
//                     <TableHeader>
//                       <TableRow>
//                         <TableHead className="w-10">S.No</TableHead>
//                         <TableHead className="w-8">Select</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Client Name</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("desc");
//                               }}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Email</TableHead>
//                         <TableHead>Phone</TableHead>
//                         <TableHead>Assigned To</TableHead>
//                         <TableHead>Stage</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Closed At</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => handleSort("created_at")}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("created_at");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Deadline</TableHead>
//                         <TableHead>Actions</TableHead>
//                       </TableRow>
//                     </TableHeader>
//                     <TableBody>
//                       {sortedClients.map((client, idx) => {
//                         const checked = selectedIds.has(client.id);
//                         return (
//                           <TableRow key={`${client.id}-${idx}`}>
//                             <TableCell>{idx + 1}</TableCell>

//                             {/* Checkbox column */}
//                             <TableCell>
//                               <input
//                                 type="checkbox"
//                                 className="h-4 w-4"
//                                 checked={checked}
//                                 onChange={() => toggleOne(client.id)}
//                                 aria-label={`Select ${client.client_name}`}
//                               />
//                             </TableCell>

//                             <TableCell
//                               className="font-medium max-w-[180px] break-words whitespace-normal cursor-pointer text-blue-600 hover:underline"
//                               onClick={() => window.open(`/leads/${client.id}`, "_blank")}
//                             >
//                               {client.client_name}
//                             </TableCell>

//                             <TableCell className="max-w-[220px] break-words whitespace-normal">{client.email}</TableCell>
//                             <TableCell>{client.phone || "-"}</TableCell>
//                             <TableCell>{client.assigned_to}</TableCell>

//                             <TableCell>
//                               <Select
//                                 value={accountStages.includes(client.stage) ? client.stage : undefined}
//                                 onValueChange={(value: AccountStage) => handleStageUpdate(client.id, value)}
//                               >
//                                 <SelectTrigger className="w-44">
//                                   <SelectValue placeholder="Select Stage" />
//                                 </SelectTrigger>
//                                 <SelectContent>
//                                   {accountStages.map((stage) => (
//                                     <SelectItem key={stage} value={stage}>
//                                       <span className={`inline-flex px-2 py-1 rounded ${getStageColor(stage)}`}>{stage}</span>
//                                     </SelectItem>
//                                   ))}
//                                 </SelectContent>
//                               </Select>
//                             </TableCell>

//                             <TableCell>{formatDate(client.created_at)}</TableCell>
//                             <TableCell>{getRenewWithinBadge(client.created_at)}</TableCell>

//                             <TableCell>
//                               <div className="flex gap-2">
//                                 <Button
//                                   size="sm"
//                                   variant="outline"
//                                   onClick={() => {
//                                     setSelectedClient(client);
//                                     setHistoryDialogOpen(true);
//                                   }}
//                                   aria-label="View history"
//                                   title="View history"
//                                 >
//                                   <Eye className="h-4 w-4" />
//                                 </Button>
//                                 <Button
//                                   size="sm"
//                                   variant="outline"
//                                   onClick={() => {
//                                     setSelectedClient(client);
//                                     if (client.feedback) setFeedbackForm(client.feedback);
//                                     setFeedbackDialogOpen(true);
//                                     prevStageRef.current = client.stage;
//                                   }}
//                                   aria-label="Add feedback"
//                                   title="Add feedback"
//                                 >
//                                   <MessageSquare className="h-4 w-4" />
//                                 </Button>
//                               </div>
//                             </TableCell>
//                           </TableRow>
//                         );
//                       })}
//                     </TableBody>
//                   </Table>
//                 </div>
//               </CardContent>
//             </Card>

//             {/* HISTORY DIALOG */}
//             <Dialog open={historyDialogOpen} onOpenChange={setHistoryDialogOpen}>
//               <DialogContent className="max-w-2xl">
//                 <DialogHeader>
//                   <DialogTitle>{selectedClient?.client_name} - Full History</DialogTitle>
//                   <DialogDescription>Complete follow-up history and client interactions</DialogDescription>
//                 </DialogHeader>

//                 {selectedClient && (
//                   <div className="space-y-6">
//                     <div className="grid grid-cols-2 gap-4">
//                       <div>
//                         <Label className="text-sm font-medium">Email</Label>
//                         <p className="text-sm text-gray-600 break-words">{selectedClient.email}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Assigned To</Label>
//                         <p className="text-sm text-gray-600">{selectedClient.assigned_to}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Current Stage</Label>
//                         <Badge className={getStageColor(selectedClient.stage)}>{selectedClient.stage}</Badge>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Closed</Label>
//                         <p className="text-sm text-gray-600">{formatDate(selectedClient.created_at)}</p>
//                       </div>
//                     </div>

//                     <div>
//                       <Label className="text-sm font-medium mb-3 block">Follow-up History</Label>
//                       <div className="space-y-3 max-h-64 overflow-y-auto">
//                         {callHistory.length > 0 ? (
//                           callHistory.map((entry, index) => (
//                             <div key={index} className="p-3 bg-gray-50 rounded-lg">
//                               <div className="flex items-center gap-2 mb-2">
//                                 <Calendar className="h-4 w-4 text-gray-500" />
//                                 <span className="text-sm font-medium">{entry.followup_date}</span>
//                               </div>
//                               <div className="mb-2">
//                                 <span className="text-sm font-medium">Stage: </span>
//                                 <Badge className={getStageColor(entry.current_stage)}>{entry.current_stage}</Badge>
//                               </div>
//                               <p className="text-sm text-gray-600 whitespace-pre-wrap">{entry.notes}</p>
//                             </div>
//                           ))
//                         ) : (
//                           <p className="text-sm text-gray-600">No follow-up history available.</p>
//                         )}
//                       </div>
//                     </div>

//                     {clientFeedback && (
//                       <div>
//                         <Label className="text-sm font-medium mb-3 block">Latest Feedback</Label>
//                         <div className="p-3 bg-blue-50 rounded-lg space-y-2">
//                           <div className="flex items-center justify-between">
//                             <div className="flex items-center gap-2">
//                               <span className="text-sm font-medium">Rating:</span>
//                               <div className="flex">{renderStars(clientFeedback.rating)}</div>
//                             </div>
//                             <Badge variant={clientFeedback.isHappy ? "default" : "secondary"}>
//                               {clientFeedback.isHappy ? "Happy" : "Needs Attention"}
//                             </Badge>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Will Renew: </span>
//                             <span className={`text-sm ${clientFeedback.willRenew ? "text-green-600" : "text-red-600"}`}>
//                               {clientFeedback.willRenew ? "Yes" : "No"}
//                             </span>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Notes: </span>
//                             <p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">{clientFeedback.notes}</p>
//                           </div>
//                           <div className="text-xs text-gray-500">Feedback Date: {clientFeedback.date}</div>
//                         </div>
//                       </div>
//                     )}
//                   </div>
//                 )}
//               </DialogContent>
//             </Dialog>

//             {/* FEEDBACK DIALOG */}
//             <Dialog open={feedbackDialogOpen} onOpenChange={onFeedbackDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Client Feedback</DialogTitle>
//                   <DialogDescription>Collect feedback from {selectedClient?.client_name}</DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Is Client Happy?</Label>
//                     <Select
//                       value={feedbackForm.isHappy ? "happy" : "unhappy"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, isHappy: value === "happy" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="happy">Happy</SelectItem>
//                         <SelectItem value="unhappy">Unhappy</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Rating (1-5)</Label>
//                     <Select
//                       value={String(feedbackForm.rating)}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, rating: Number(value) }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         {[1, 2, 3, 4, 5].map((rating) => (
//                           <SelectItem key={rating} value={String(rating)}>
//                             <div className="flex items-center gap-2">
//                               <span>{rating}</span>
//                               <div className="flex">{renderStars(rating)}</div>
//                             </div>
//                           </SelectItem>
//                         ))}
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label>Notes</Label>
//                     <Textarea
//                       placeholder="Enter detailed feedback..."
//                       value={feedbackForm.notes}
//                       onChange={(e) => setFeedbackForm((prev) => ({ ...prev, notes: e.target.value }))}
//                     />
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Will Client Renew?</Label>
//                     <Select
//                       value={feedbackForm.willRenew ? "yes" : "no"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, willRenew: value === "yes" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="yes">Yes</SelectItem>
//                         <SelectItem value="no">No</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFeedbackDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFeedbackSubmit}>Save Feedback</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* FOLLOW-UP DIALOG */}
//             <Dialog open={followUpDialogOpen} onOpenChange={onFollowUpDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Schedule Follow-up</DialogTitle>
//                 </DialogHeader>
//                 <div className="space-y-4">
//                   <div>
//                     <Label className="block mb-1">Follow-up Date</Label>
//                     <Input
//                       type="date"
//                       value={followUpForm.date}
//                       onChange={(e) => setFollowUpForm((f) => ({ ...f, date: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                   <div>
//                     <Label className="block mb-1">Notes</Label>
//                     <Textarea
//                       placeholder="Add notes..."
//                       value={followUpForm.notes}
//                       onChange={(e) => setFollowUpForm((f) => ({ ...f, notes: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                 </div>
//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFollowUpDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFollowUpSave}>Save Follow-up</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* CSV UPLOAD */}
//             <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>
//               <DialogContent className="max-w-5xl">
//                 <DialogHeader>
//                   <DialogTitle>Upload Sale Done CSV</DialogTitle>
//                   <DialogDescription>
//                     Upload your sales CSV. We'll parse and show the number of entries.
//                     <br />
//                     Required columns:
//                     <br />
//                     <code>lead_id, Name, Rate, Payment Frequency, sale_done, Onboarded date, Phone number, email</code>
//                     <br />
//                     Dates must be <code>yyyy-mm-dd</code>.
//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Input
//                     type="file"
//                     accept=".csv"
//                     onChange={(e) => {
//                       const file = e.target.files?.[0];
//                       if (file) {
//                         setCsvFile(file);
//                         handleCSVUpload(file);
//                       }
//                     }}
//                   />
//                   <p className="text-sm text-gray-600">
//                     {csvData.length > 0 ? `‚úÖ Detected ${csvData.length} records in file.` : "No file parsed yet."}
//                   </p>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setUploadDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleCSVSubmit} disabled={csvData.length === 0}>
//                     Submit to Supabase
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* BULK ASSIGN DIALOG */}
//             <Dialog open={bulkDialogOpen} onOpenChange={setBulkDialogOpen}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Bulk Assign to Accounts Associate</DialogTitle>
//                   <DialogDescription>
//                     {selectedIds.size} selected {selectedIds.size === 1 ? "client" : "clients"}
//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Label className="text-sm font-medium">Select Accounts Associate</Label>
//                   <Select
//                     value={selectedAssociateEmail}
//                     onValueChange={(v) => setSelectedAssociateEmail(v)}
//                   >
//                     <SelectTrigger>
//                       <SelectValue placeholder="Choose associate..." />
//                     </SelectTrigger>
//                     <SelectContent>
//                       {associates.map((a) => (
//                         <SelectItem key={a.email} value={a.email}>
//                           {a.name} ‚Äî {a.email}
//                         </SelectItem>
//                       ))}
//                     </SelectContent>
//                   </Select>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setBulkDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button disabled={!selectedAssociateEmail} onClick={doBulkAssign}>
//                     Assign
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>
//           </div>
//         </DashboardLayout>
//       </ProtectedRoute>
//     </>
//   );
// }


// // app/account-management/page.tsx
// "use client";

// import * as React from "react";
// import { useEffect, useMemo, useRef, useState } from "react";
// import { supabase } from "@/utils/supabase/client";
// import { DashboardLayout } from "@/components/layout/dashboard-layout";
// import { Button } from "@/components/ui/button";
// import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
// import { Badge } from "@/components/ui/badge";
// import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
// import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
// import { Input } from "@/components/ui/input";
// import { Label } from "@/components/ui/label";
// import { Textarea } from "@/components/ui/textarea";
// import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
// import { Eye, MessageSquare, Star, Calendar } from "lucide-react";
// import ProtectedRoute from "@/components/auth/ProtectedRoute";
// import Papa from "papaparse";
// import FullScreenLoader from "@/components/ui/FullScreenLoader";

// /** =========================
//  *  Config ‚Äî now writing to the new columns you created
//  *  ========================= */
// const ACCOUNT_EMAIL_COL = "account_assigned_email";
// const ACCOUNT_NAME_COL  = "account_assigned_name";

// type AccountStage = "DNP" | "Call Again" | "Conversation Done";

// interface FollowUp {
//   date: string;
//   notes: string;
// }

// interface Feedback {
//   isHappy: boolean;
//   rating: number;
//   notes: string;
//   willRenew: boolean;
//   date: string; // yyyy-mm-dd
// }

// interface Client {
//   id: string;
//   client_name: string;
//   email: string;
//   phone?: string | null;
//   /** lead owner from leads table (kept as-is) */
//   assigned_to: string;
//   /** account assignment from sales_closure (NEW) */
//   account_assigned_name?: string | null;
//   account_assigned_email?: string | null;

//   stage: AccountStage;
//   created_at: string; // ISO or yyyy-mm-dd
//   follow_ups?: FollowUp[];
//   feedback?: Feedback;
// }

// const accountStages: AccountStage[] = ["DNP", "Call Again", "Conversation Done"];

// const getStageColor = (stage: AccountStage) => {
//   switch (stage) {
//     case "DNP":
//       return "bg-yellow-100 text-yellow-800";
//     case "Call Again":
//       return "bg-blue-100 text-blue-800";
//     case "Conversation Done":
//       return "bg-green-100 text-green-800";
//     default:
//       return "bg-gray-100 text-gray-800";
//   }
// };

// const formatDate = (dateString: string | undefined): string => {
//   if (!dateString) return "N/A";
//   const d = new Date(dateString);
//   return isNaN(d.getTime()) ? "N/A" : d.toLocaleDateString();
// };

// function renderStars(rating: number) {
//   return (
//     <span className="flex">
//       {Array.from({ length: 5 }, (_, i) => (
//         <Star
//           key={i}
//           className={`h-4 w-4 ${i < rating ? "fill-current text-yellow-400" : "text-gray-300"}`}
//         />
//       ))}
//     </span>
//   );
// }

// const isAssigned = (name?: string | null) => !!(name && String(name).trim().length > 0);

// export default function AccountManagementPage() {
//   const [clients, setClients] = useState<Client[]>([]);
//   const [pageLoading, setPageLoading] = useState(false);

//   const [selectedClient, setSelectedClient] = useState<Client | null>(null);
//   const [historyDialogOpen, setHistoryDialogOpen] = useState(false);
//   const [feedbackDialogOpen, setFeedbackDialogOpen] = useState(false);
//   const [followUpDialogOpen, setFollowUpDialogOpen] = useState(false);

//   const [searchTerm, setSearchTerm] = useState("");
//   const [followUpFilter, setFollowUpFilter] = useState<"All dates" | "Today">("All dates");
//   const [sortKey, setSortKey] = useState<"client_name" | "created_at" | null>(null);
//   const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc");

//   const [feedbackForm, setFeedbackForm] = useState<Feedback>({
//     isHappy: false,
//     rating: 5,
//     notes: "",
//     willRenew: false,
//     date: new Date().toISOString().split("T")[0],
//   });
//   const [followUpForm, setFollowUpForm] = useState<FollowUp>({ date: "", notes: "" });

//   const [pendingStage, setPendingStage] = useState<AccountStage | null>(null);
//   const prevStageRef = useRef<AccountStage | null>(null);
//   const changeCommittedRef = useRef<boolean>(false);

//   const [callHistory, setCallHistory] = useState<any[]>([]);
//   const [clientFeedback, setClientFeedback] = useState<Feedback | null>(null);

//   const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
//   const [csvFile, setCsvFile] = useState<File | null>(null);
//   const [csvData, setCsvData] = useState<any[]>([]);

//   /** BULK selection + assignment */
//   const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
//   const [bulkDialogOpen, setBulkDialogOpen] = useState(false);
//   const [associates, setAssociates] = useState<{ name: string; email: string }[]>([]);
//   const [selectedAssociateEmail, setSelectedAssociateEmail] = useState<string>("");

//   /** Tabs + owner filter (assigned tab) */
//   const [activeTab, setActiveTab] = useState<"unassigned" | "assigned">("unassigned");
//   const ALL_OWNERS = "__ALL_OWNERS__";
//   const [ownerFilter, setOwnerFilter] = useState<string>(ALL_OWNERS);

//   /** ===== Initial load ===== */
//   useEffect(() => {
//     let cancelled = false;

//     const fetchClients = async () => {
//       setPageLoading(true);
//       try {
//         // include new columns from sales_closure
//         const { data: rawSalesData, error: salesError } = await supabase
//           .from("sales_closure")
//           .select("lead_id, email, onboarded_date, account_assigned_email, account_assigned_name")
//           .not("onboarded_date", "is", null)
//           .order("onboarded_date", { ascending: false });

//         if (salesError || !rawSalesData) {
//           console.error("‚ùå sales_closure fetch failed", salesError);
//           return;
//         }

//         const salesDataMap = new Map<
//           string,
//           { lead_id: string; email: string; onboarded_date: string; account_assigned_email: string | null; account_assigned_name: string | null }
//         >();
//         for (const row of rawSalesData) {
//           if (!salesDataMap.has(row.lead_id)) {
//             salesDataMap.set(row.lead_id, {
//               lead_id: row.lead_id,
//               email: row.email,
//               onboarded_date: row.onboarded_date as any,
//               account_assigned_email: (row as any).account_assigned_email ?? null,
//               account_assigned_name: (row as any).account_assigned_name ?? null,
//             });
//           }
//         }
//         const salesData = Array.from(salesDataMap.values());
//         const leadIds = salesData.map((s) => s.lead_id);

//         const { data: leadsData, error: leadsError } = await supabase
//           .from("leads")
//           .select("business_id, name, phone, assigned_to, email")
//           .in("business_id", leadIds);

//         if (leadsError || !leadsData) {
//           console.error("‚ùå leads fetch failed", leadsError);
//           return;
//         }
//         const leadsMap = Object.fromEntries(leadsData.map((l) => [l.business_id, l]));

//         const { data: callRaw, error: callError } = await supabase
//           .from("call_history")
//           .select("lead_id, current_stage, followup_date")
//           .order("followup_date", { ascending: false });

//         if (callError) console.error("‚ùå call_history fetch failed", callError);

//         const latestCallMap: Record<string, any> = {};
//         for (const call of callRaw || []) {
//           if (!latestCallMap[call.lead_id]) latestCallMap[call.lead_id] = call;
//         }

//         const { data: feedbackRows, error: fbErr } = await supabase
//           .from("client_feedback")
//           .select("lead_id, client_emotion, rating, notes, renew_status, id")
//           .in("lead_id", leadIds)
//           .order("id", { ascending: false });

//         if (fbErr) console.error("‚ö†Ô∏è client_feedback fetch failed", fbErr);

//         const latestFbMap = new Map<string, Feedback>();
//         for (const r of feedbackRows || []) {
//           if (!latestFbMap.has(r.lead_id)) {
//             latestFbMap.set(r.lead_id, {
//               isHappy: r.client_emotion === "happy",
//               rating: parseInt(String(r.rating || "0"), 10),
//               notes: r.notes || "",
//               willRenew: r.renew_status === "yes",
//               date: new Date().toISOString().split("T")[0],
//             });
//           }
//         }

//         const merged: Client[] = salesData.map((sale) => {
//           const lead = leadsMap[sale.lead_id] || {};
//           const call = latestCallMap[sale.lead_id];
//           return {
//             id: sale.lead_id,
//             client_name: lead.name || "Unnamed",
//             email: sale.email || lead.email || "unknown@example.com",
//             phone: lead.phone ?? null,
//             assigned_to: lead.assigned_to || "Unassigned",
//             created_at: sale.onboarded_date,
//             stage: (call?.current_stage as AccountStage) || "DNP",
//             follow_ups: [],
//             feedback: latestFbMap.get(sale.lead_id),
//             account_assigned_name: sale.account_assigned_name,
//             account_assigned_email: sale.account_assigned_email,
//           };
//         });

//         if (!cancelled) setClients(merged);
//       } catch (err) {
//         console.error("‚ùå Unexpected error:", err);
//       } finally {
//         if (!cancelled) setPageLoading(false);
//       }
//     };

//     fetchClients();
//     return () => {
//       cancelled = true;
//     };
//   }, []);

//   /** ===== History & feedback fetch for selected client ===== */
//   useEffect(() => {
//     if (!historyDialogOpen || !selectedClient) {
//       setCallHistory([]);
//       setClientFeedback(null);
//       return;
//     }

//     const fetchCallHistoryAndFeedback = async () => {
//       const { data: callHistoryData, error: callHistoryError } = await supabase
//         .from("call_history")
//         .select("current_stage, followup_date, notes")
//         .eq("lead_id", selectedClient.id)
//         .order("followup_date", { ascending: false });

//       if (callHistoryError) {
//         console.error(`Error fetching call history for lead ${selectedClient.id}:`, JSON.stringify(callHistoryError, null, 2));
//       } else {
//         setCallHistory(callHistoryData || []);
//       }

//       const { data: feedbackData, error: feedbackError } = await supabase
//         .from("client_feedback")
//         .select("client_emotion, rating, notes, renew_status, id")
//         .eq("lead_id", selectedClient.id)
//         .order("id", { ascending: false })
//         .limit(1);

//       if (feedbackError) {
//         console.error(`Error fetching client feedback for lead ${selectedClient.id}:`, JSON.stringify(feedbackError, null, 2));
//       } else if (feedbackData?.[0]) {
//         const row = feedbackData[0];
//         setClientFeedback({
//           isHappy: row.client_emotion === "happy",
//           rating: parseInt(String(row.rating || "0"), 10),
//           notes: row.notes || "",
//           willRenew: row.renew_status === "yes",
//           date: new Date().toISOString().split("T")[0],
//         });
//       }
//     };

//     fetchCallHistoryAndFeedback();
//   }, [historyDialogOpen, selectedClient]);

//   /** ===== Base filter by search and the 15-day "Today" chip ===== */
//   const baseFiltered = useMemo(() => {
//     const term = searchTerm.trim().toLowerCase();
//     const bySearch = (c: Client) =>
//       c.email.toLowerCase().includes(term) ||
//       c.client_name.toLowerCase().includes(term) ||
//       (c.phone ?? "").toString().toLowerCase().includes(term);

//     if (followUpFilter === "Today") {
//       const today = new Date();
//       return clients.filter((client) => {
//         const createdAt = new Date(client.created_at);
//         const diffInDays = Math.floor((today.getTime() - createdAt.getTime()) / 86400000);
//         return diffInDays === 15 && bySearch(client);
//       });
//     }
//     return clients.filter(bySearch);
//   }, [clients, searchTerm, followUpFilter]);

//   /** ===== Tab filtering ===== */
//   const tabFiltered = useMemo(() => {
//   if (activeTab === "unassigned") {
//     return baseFiltered.filter((c) => !isAssigned(c.account_assigned_name));
//   } else {
//     let arr = baseFiltered.filter((c) => isAssigned(c.account_assigned_name));
//     if (ownerFilter !== ALL_OWNERS) {
//       arr = arr.filter((c) => (c.account_assigned_name || "").trim() === ownerFilter);
//     }
//     return arr;
//   }
// }, [baseFiltered, activeTab, ownerFilter]);


//   /** ===== Sorting ===== */
//   const sortedClients = useMemo(() => {
//     if (!sortKey) return tabFiltered;
//     const arr = [...tabFiltered];
//     if (sortKey === "created_at") {
//       arr.sort((a, b) => {
//         const da = new Date(a.created_at).getTime();
//         const db = new Date(b.created_at).getTime();
//         return sortOrder === "asc" ? da - db : db - da;
//       });
//     } else if (sortKey === "client_name") {
//       arr.sort((a, b) => {
//         const va = (a.client_name || "").toLowerCase();
//         const vb = (b.client_name || "").toLowerCase();
//         if (va === vb) return 0;
//         return sortOrder === "asc" ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
//       });
//     }
//     return arr;
//   }, [tabFiltered, sortKey, sortOrder]);

//   const handleSort = (key: "client_name" | "created_at") => {
//     if (sortKey === key) {
//       setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
//     } else {
//       setSortKey(key);
//       setSortOrder("asc");
//     }
//   };

//   /** ===== Counts & owners ===== */
//   const assignedCountAll = useMemo(
//     () => clients.filter((c) => isAssigned(c.account_assigned_name)).length,
//     [clients]
//   );
//   const unassignedCountAll = useMemo(
//     () => clients.length - assignedCountAll,
//     [clients, assignedCountAll]
//   );

//   const ownerNames = useMemo(() => {
//     const s = new Set<string>();
//     clients.forEach((c) => {
//       const nm = (c.account_assigned_name || "").trim();
//       if (nm) s.add(nm);
//     });
//     return Array.from(s).sort((a, b) => a.localeCompare(b));
//   }, [clients]);

// const ownerCount = useMemo(() => {
//   if (ownerFilter === ALL_OWNERS) return 0; // only show count when a specific owner is picked
//   return clients.filter((c) => (c.account_assigned_name || "").trim() === ownerFilter).length;
// }, [clients, ownerFilter]);


//   /** ===== Deadline badge ===== */
//   const getRenewWithinBadge = (createdAt: string): React.ReactNode => {
//     if (!createdAt) return "-";
//     const closedDate = new Date(createdAt);
//     const today = new Date();
//     const diffInDays = Math.floor((today.getTime() - closedDate.getTime()) / 86400000);
//     if (diffInDays < 15) {
//       const daysLeft = 15 - diffInDays;
//       return <Badge className="bg-green-100 text-green-800">Within {daysLeft} day{daysLeft === 1 ? "" : "s"}</Badge>;
//     } else if (diffInDays === 15) {
//       return <Badge className="bg-yellow-100 text-gray-800">Today lastdate</Badge>;
//     } else {
//       const overdueDays = diffInDays - 15;
//       return <Badge className="bg-red-100 text-red-800">Overdue by {overdueDays} day{overdueDays === 1 ? "" : "s"}</Badge>;
//     }
//   };

//   /** ===== Stage transitions (existing) ===== */
//   const handleStageUpdate = (clientId: string, newStage: AccountStage) => {
//     const current = clients.find((c) => c.id === clientId);
//     if (!current) return;
//     prevStageRef.current = current.stage;
//     changeCommittedRef.current = false;

//     setClients((prev) => prev.map((c) => (c.id === clientId ? { ...c, stage: newStage } : c)));
//     const clientWithUpdatedStage = { ...current, stage: newStage };
//     setSelectedClient(clientWithUpdatedStage);

//     if (newStage === "Conversation Done") {
//       setFeedbackForm({
//         isHappy: false,
//         rating: 5,
//         notes: "",
//         willRenew: false,
//         date: new Date().toISOString().split("T")[0],
//       });
//       setFeedbackDialogOpen(true);
//     } else {
//       setPendingStage(newStage);
//       setFollowUpForm({
//         date: new Date().toISOString().split("T")[0],
//         notes: "",
//       });
//       setFollowUpDialogOpen(true);
//     }
//   };
//   const onFollowUpDialogOpenChange = (open: boolean) => {
//     setFollowUpDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       setClients((prev) => prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c)));
//       setPendingStage(null);
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };
//   const onFeedbackDialogOpenChange = (open: boolean) => {
//     setFeedbackDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       setClients((prev) => prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c)));
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };

//   const handleFeedbackSubmit = async () => {
//     if (!selectedClient) {
//       alert("No client selected.");
//       return;
//     }
//     if (!feedbackForm.rating || feedbackForm.rating < 1 || feedbackForm.rating > 5) {
//       alert("Please select a valid rating between 1 and 5.");
//       return;
//     }
//     if (!feedbackForm.notes || feedbackForm.notes.trim() === "") {
//       alert("Please provide feedback notes.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse =
//       !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const { data: leadCheck, error: leadCheckError } = await supabase
//       .from("leads")
//       .select("business_id")
//       .eq("business_id", selectedClient.id)
//       .limit(1);
//     if (leadCheckError || !leadCheck || leadCheck.length === 0) {
//       alert("Lead does not exist. Please create the lead first.");
//       return;
//     }

//     const feedbackRow = {
//       lead_id: selectedClient.id,
//       client_emotion: feedbackForm.isHappy ? "happy" : "unhappy",
//       rating: feedbackForm.rating.toString(),
//       notes: feedbackForm.notes.trim(),
//       renew_status: feedbackForm.willRenew ? "yes" : "no",
//       email: emailToUse,
//     };
//     const { error: fbErr } = await supabase.from("client_feedback").insert([feedbackRow]);
//     if (fbErr) {
//       console.error("Error saving feedback:", fbErr);
//       alert(`Failed to save feedback: ${fbErr.message}`);
//       return;
//     }

//     const { error: chErr } = await supabase.from("call_history").insert([
//       {
//         lead_id: selectedClient.id,
//         current_stage: "Conversation Done",
//         followup_date: feedbackForm.date,
//         notes: `Feedback recorded: rating ${feedbackForm.rating}/5. ${feedbackForm.notes}`.slice(0, 1000),
//         assigned_to: selectedClient.assigned_to || "Unassigned",
//         email: emailToUse,
//         phone: phoneToUse,
//       },
//     ]);
//     if (chErr) console.error("Error writing call_history for Conversation Done:", chErr);

//     setClients((prev) =>
//       prev.map((c) => (c.id === selectedClient.id ? { ...c, feedback: feedbackForm, stage: "Conversation Done" } : c))
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFeedbackDialogOpen(false);
//     setFeedbackForm({ isHappy: false, rating: 5, notes: "", willRenew: false, date: new Date().toISOString().split("T")[0] });
//   };

//   const handleFollowUpSave = async () => {
//     if (!selectedClient || !pendingStage) {
//       alert("No client or stage selected.");
//       return;
//     }
//     if (!followUpForm.date || !followUpForm.notes.trim()) {
//       alert("Please provide a follow-up date and notes.");
//       return;
//     }

//     const emailToUse =
//       !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse =
//       !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const followUpData = {
//       lead_id: selectedClient.id,
//       current_stage: pendingStage,
//       followup_date: followUpForm.date,
//       notes: followUpForm.notes.trim(),
//       assigned_to: selectedClient.assigned_to || "Unassigned",
//       email: emailToUse,
//       phone: phoneToUse,
//     };

//     const { error } = await supabase.from("call_history").insert([followUpData]);
//     if (error) {
//       console.error("Error saving follow-up:", error);
//       alert("Failed to save follow-up. Please try again.");
//       return;
//     }

//     setClients((prev) =>
//       prev.map((client) =>
//         client.id === selectedClient.id
//           ? {
//               ...client,
//               stage: pendingStage,
//               follow_ups: [...(client.follow_ups || []), { date: followUpForm.date, notes: followUpForm.notes }],
//             }
//           : client
//       )
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFollowUpDialogOpen(false);
//     setFollowUpForm({ date: "", notes: "" });
//     setPendingStage(null);
//   };

//   /** ===== CSV upload ===== */
//   const handleCSVUpload = (file: File) => {
//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const requiredFields = [
//           "lead_id",
//           "Name",
//           "Rate",
//           "Payment Frequency",
//           "sale_done",
//           "Onboarded date",
//           "Phone number",
//           "email",
//         ];
//         const fields: string[] = Array.isArray(results.meta.fields) ? (results.meta.fields as string[]) : [];
//         const missingFields = requiredFields.filter((f) => !fields.includes(f));
//         if (missingFields.length > 0) {
//           alert(`Missing required columns: ${missingFields.join(", ")}`);
//           return;
//         }
//         setCsvData(results.data as any[]);
//       },
//       error: function (error) {
//         console.error("CSV parsing error:", error);
//         alert("Failed to parse CSV.");
//       },
//     });
//   };

//   const handleCSVSubmit = async () => {
//     if (csvData.length === 0) {
//       alert("No CSV data to submit");
//       return;
//     }

//     try {
//       const salesToInsert: any[] = [];

//       for (const row of csvData) {
//         const lead_id = row["lead_id"]?.trim?.();
//         const name = row["Name"]?.trim?.();
//         const email = row["email"]?.trim?.();
//         const sale_value = parseFloat(row["Rate"]);
//         const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//         const date = new Date(row["Onboarded date"]);
//         const sale_done = new Date(row["sale_done"]);

//         if (!lead_id || !name || !email || !sale_value || !subscription_cycle || isNaN(date.getTime()) || isNaN(sale_done.getTime())) {
//           console.warn("‚ùå Skipping invalid row:", row);
//           continue;
//         }

//         salesToInsert.push({
//           lead_id,
//           lead_name: name,
//           email,
//           sale_value,
//           subscription_cycle,
//           payment_mode: "UPI",
//           finance_status: "Paid",
//           closed_at: sale_done.toISOString(),
//           onboarded_date: date.toISOString().split("T")[0],
//         });
//       }

//       if (salesToInsert.length === 0) {
//         alert("No valid rows to upload.");
//         return;
//       }

//       const { error } = await supabase.from("sales_closure").insert(salesToInsert);
//       if (error) throw error;

//       alert(`üéâ Successfully inserted ${salesToInsert.length} renewal records into sales_closure`);
//       setUploadDialogOpen(false);
//       setCsvData([]);
//       setCsvFile(null);
//     } catch (err: any) {
//       console.error("‚ùå Upload failed:", err);
//       alert(`Upload failed: ${err?.message || String(err)}`);
//     }
//   };

//   /** ===== Dashboard aggregates ===== */
//   const happyCount = useMemo(
//     () => clients.reduce((acc, c) => (c.feedback?.isHappy ? acc + 1 : acc), 0),
//     [clients]
//   );
//   const willRenewCount = useMemo(
//     () => clients.reduce((acc, c) => (c.feedback?.willRenew ? acc + 1 : acc), 0),
//     [clients]
//   );
//   const avgRating = useMemo(() => {
//     const fb = clients.map((c) => c.feedback).filter(Boolean) as Feedback[];
//     if (fb.length === 0) return "N/A";
//     const mean = fb.reduce((s, f) => s + (f.rating || 0), 0) / fb.length;
//     return mean.toFixed(1);
//   }, [clients]);

//   /** ===== Bulk helpers ===== */
//   const toggleOne = (id: string) => {
//     const row = sortedClients.find((c) => c.id === id);
//     if (row && isAssigned(row.account_assigned_name)) return; // guard: cannot be selected
//     setSelectedIds((prev) => {
//       const next = new Set(prev);
//       if (next.has(id)) next.delete(id);
//       else next.add(id);
//       return next;
//     });
//   };

//   const quickSelect = (n: number) => {
//     // Only among currently visible UNASSIGNED rows
//     const eligible = sortedClients.filter((c) => !isAssigned(c.account_assigned_name));
//     const firstN = eligible.slice(0, n).map((c) => c.id);
//     setSelectedIds(new Set(firstN));
//   };

//   const clearSelection = () => setSelectedIds(new Set());

//   // Clear selection when switching to Assigned tab (no checkboxes there)
//   useEffect(() => {
//     if (activeTab === "assigned") clearSelection();
//   }, [activeTab]);

//  const openBulkDialog = async () => {
//   if (selectedIds.size === 0) return;
//   setBulkDialogOpen(true);
//   const { data, error } = await supabase
//     .from("profiles")
//     .select("full_name, user_email, roles")
//     .eq("roles", "Accounts Associate");

//   if (error) {
//     console.error("Failed to load Accounts Associates:", error);
//     return;
//   }

//   setAssociates(
//     (data || [])
//       .map((r) => ({
//         name: (r.full_name || "").trim() || (r.user_email || "").trim(),
//         email: (r.user_email || "").trim(),
//       }))
//       .filter((a) => a.email.length > 0) // <- no empty values allowed
//       .sort((a, b) => a.name.localeCompare(b.name))
//   );
// };


//   const doBulkAssign = async () => {
//     if (!selectedAssociateEmail) {
//       alert("Choose an Accounts Associate.");
//       return;
//     }
//     const picked = associates.find((a) => a.email === selectedAssociateEmail);
//     if (!picked) {
//       alert("Invalid associate.");
//       return;
//     }
//     const leadIds = Array.from(selectedIds);
//     if (leadIds.length === 0) return;

//     const payload: Record<string, any> = {};
//     payload[ACCOUNT_EMAIL_COL] = picked.email;
//     payload[ACCOUNT_NAME_COL]  = picked.name;

//     const { error } = await supabase
//       .from("sales_closure")
//       .update(payload)
//       .in("lead_id", leadIds);

//     if (error) {
//       console.error("Bulk assign failed:", error);
//       alert("Bulk assign failed. Check permissions/RLS.");
//       return;
//     }

//     // Update UI: fill account_assigned_* and remove them from selection (they move to Assigned tab)
//     setClients((prev) =>
//       prev.map((c) =>
//         selectedIds.has(c.id)
//           ? { ...c, account_assigned_name: picked.name, account_assigned_email: picked.email }
//           : c
//       )
//     );

//     setBulkDialogOpen(false);
//     setSelectedAssociateEmail("");
//     clearSelection();
//     setActiveTab("assigned"); // jump to assigned to verify
//   };

//   return (
//     <>
//       {pageLoading && <FullScreenLoader />}
//       <ProtectedRoute allowedRoles={["Account Management", "Super Admin"]}>
//         <DashboardLayout>
//           <div className="space-y-6">
//             <div className="flex justify-between items-center">
//               <div>
//                 <h1 className="text-3xl font-bold text-gray-900">Account Management CRM</h1>
//                 <p className="text-gray-600 mt-2">Manage client relationships and feedback</p>
//               </div>

//               <div className="flex items-center gap-2">

//                 <Button onClick={() => setUploadDialogOpen(true)}>Upload Sale Done CSV</Button>
//               </div>
//             </div>

//             {/* Summary cards */}
//             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Happy Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{happyCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Renewal Intent</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{willRenewCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Avg Rating</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{avgRating}</div>
//                 </CardContent>
//               </Card>
//             </div>

//             <Card>
//               <CardHeader>
//                 <div className="flex items-center justify-between">
//                   <div>
//                     <CardTitle>Account Management Dashboard</CardTitle>
//                     <CardDescription>Manage client accounts and track feedback</CardDescription>
//                   </div>

//                   {/* Tabs + Owner dropdown */}
//                          </div>
//               </CardHeader>

//               <CardContent>
//                 <div className="flex items-center justify-between mt-4">
//                    <div className="flex items-center gap-3">
//                    <Input
//                     placeholder="Search by email, name, or phone"
//                     value={searchTerm}
//                     onChange={(e) => setSearchTerm(e.target.value)}
//                     className="max-w-3xl"
//                   />

              
//                     <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)}>
//                       <TabsList>
//                         <TabsTrigger value="unassigned">Unassigned ({unassignedCountAll})</TabsTrigger>
//                         <TabsTrigger value="assigned">Assigned ({assignedCountAll})</TabsTrigger>
//                       </TabsList>
//                     </Tabs>
//                       {activeTab === "assigned" && (
//                       <div className="flex items-center gap-2">
//                         <span className="text-sm text-gray-600">Owner:</span>
//                         <Select value={ownerFilter} onValueChange={setOwnerFilter}>
//   <SelectTrigger className="w-56">
//     <SelectValue placeholder="All owners" />
//   </SelectTrigger>
//   <SelectContent>
//     <SelectItem value={ALL_OWNERS}>All owners</SelectItem>
//     {ownerNames.map((nm) => (
//       <SelectItem key={nm} value={nm}>
//         {nm}
//       </SelectItem>
//     ))}
//   </SelectContent>
// </Select>
//                    {ownerFilter !== ALL_OWNERS && (
//   <span className="text-sm max-w-10 flex text-gray-600">
//     Count: <b>{ownerCount}</b>
//   </span>
// )}
//                       </div>
//                     )}

                   
//                   </div>
         
// <div className="flex items-center gap-2">
//                 {/* Quick select chips (only relevant on Unassigned tab) */}
//                 {activeTab === "unassigned" && (
//                   <div className="hidden md:flex items-center gap-2 mr-2">
//                     <span className="text-sm text-gray-600">Select first:</span>
//                     {[10, 20, 40, 50].map((n) => (
//                       <Button key={n} size="sm" variant="outline" onClick={() => quickSelect(n)}>
//                         {n}
//                       </Button>
//                     ))}
//                     <Button size="sm" variant="ghost" onClick={clearSelection}>
//                       Clear
//                     </Button>
//                   </div>
//                 )}

//                 <Button
//                   variant="default"
//                   disabled={selectedIds.size === 0}
//                   onClick={openBulkDialog}
//                   title={selectedIds.size ? `Bulk assign ${selectedIds.size} selected` : "Select rows first"}
//                 >
//                   Bulk Assign
//                 </Button>

//                   <Select value={followUpFilter} onValueChange={(v) => setFollowUpFilter(v as "All dates" | "Today")}>
//                     <SelectTrigger className="w-40">
//                       <SelectValue placeholder="Follow Up" />
//                     </SelectTrigger>
//                     <SelectContent>
//                       <SelectItem value="All dates">All dates</SelectItem>
//                       <SelectItem value="Today">Due today (15th day)</SelectItem>
//                     </SelectContent>
//                   </Select>
//                 </div>
// </div>
//                 <div className="text-sm text-gray-500 mt-2">
//                   Showing <b>{sortedClients.length}</b> {activeTab} result{sortedClients.length === 1 ? "" : "s"}
//                   {ownerFilter && activeTab === "assigned" ? <> for <b>{ownerFilter}</b></> : null}
//                 </div>

//                 <div className="rounded-md border mt-4">
//                   <Table>
//                     <TableHeader>
//                       <TableRow>
//                         <TableHead className="w-10">S.No</TableHead>
//                         <TableHead className="w-8">Select</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Client Name</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("desc");
//                               }}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Email</TableHead>
//                         <TableHead>Phone</TableHead>
//                         <TableHead>Assigned To</TableHead>
//                         <TableHead>Stage</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Closed At</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => handleSort("created_at")}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("created_at");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Deadline</TableHead>
//                         {/* NEW: Account Owner column */}
//                         <TableHead  className="text-center">Account Owner</TableHead>

//                         <TableHead>Actions</TableHead>
//                       </TableRow>
//                     </TableHeader>
//                     <TableBody>
//                       {sortedClients.map((client, idx) => {
//                         const assigned = isAssigned(client.account_assigned_name);
//                         const checked = selectedIds.has(client.id);
//                         return (
//                           <TableRow key={`${client.id}-${idx}`}>
//                             <TableCell>{idx + 1}</TableCell>

//                             {/* Checkbox only if UNASSIGNED */}
//                             <TableCell>
//                               {!assigned ? (
//                                 <input
//                                   type="checkbox"
//                                   className="h-4 w-4"
//                                   checked={checked}
//                                   onChange={() => toggleOne(client.id)}
//                                   aria-label={`Select ${client.client_name}`}
//                                 />
//                               ) : null}
//                             </TableCell>

//                             <TableCell
//                               className="font-medium max-w-[180px] break-words whitespace-normal cursor-pointer text-blue-600 hover:underline"
//                               onClick={() => window.open(`/leads/${client.id}`, "_blank")}
//                             >
//                               {client.client_name}
//                             </TableCell>

//                             <TableCell className="max-w-[220px] break-words whitespace-normal">{client.email}</TableCell>
//                             <TableCell>{client.phone || "-"}</TableCell>
//                             <TableCell>{client.assigned_to}</TableCell>

//                             <TableCell>
//                               <Select
//                                 value={accountStages.includes(client.stage) ? client.stage : undefined}
//                                 onValueChange={(value: AccountStage) => handleStageUpdate(client.id, value)}
//                               >
//                                 <SelectTrigger className="w-44">
//                                   <SelectValue placeholder="Select Stage" />
//                                 </SelectTrigger>
//                                 <SelectContent>
//                                   {accountStages.map((stage) => (
//                                     <SelectItem key={stage} value={stage}>
//                                       <span className={`inline-flex px-2 py-1 rounded ${getStageColor(stage)}`}>{stage}</span>
//                                     </SelectItem>
//                                   ))}
//                                 </SelectContent>
//                               </Select>
//                             </TableCell>

//                             <TableCell>{formatDate(client.created_at)}</TableCell>
//                             <TableCell>{getRenewWithinBadge(client.created_at)}</TableCell>

//                             {/* NEW: Account Owner cell */}
//                             {/* <TableCell>{client.account_assigned_name ? client.account_assigned_name : "Not"}</TableCell> */}
// <TableCell className="text-center">
//   {client.account_assigned_name && client.account_assigned_name.trim() ? (
//     <span className="bg-gray-200 text-gray-800 text-md font-bold p-2 rounded-lg">
//       {client.account_assigned_name}
//     </span>
//   ) : (
//     <Badge className="bg-red-100 text-red-800">
//       Not Assigned
//     </Badge>
//   )}
// </TableCell>

//                             <TableCell>
//                               <div className="flex gap-2">
//                                 <Button
//                                   size="sm"
//                                   variant="outline"
//                                   onClick={() => {
//                                     setSelectedClient(client);
//                                     setHistoryDialogOpen(true);
//                                   }}
//                                   aria-label="View history"
//                                   title="View history"
//                                 >
//                                   <Eye className="h-4 w-4" />
//                                 </Button>
//                                 <Button
//                                   size="sm"
//                                   variant="outline"
//                                   onClick={() => {
//                                     setSelectedClient(client);
//                                     if (client.feedback) setFeedbackForm(client.feedback);
//                                     setFeedbackDialogOpen(true);
//                                     prevStageRef.current = client.stage;
//                                   }}
//                                   aria-label="Add feedback"
//                                   title="Add feedback"
//                                 >
//                                   <MessageSquare className="h-4 w-4" />
//                                 </Button>
//                               </div>
//                             </TableCell>
//                           </TableRow>
//                         );
//                       })}
//                     </TableBody>
//                   </Table>
//                 </div>
//               </CardContent>
//             </Card>

//             {/* HISTORY DIALOG */}
//             <Dialog open={historyDialogOpen} onOpenChange={setHistoryDialogOpen}>
//               <DialogContent className="max-w-2xl">
//                 <DialogHeader>
//                   <DialogTitle>{selectedClient?.client_name} - Full History</DialogTitle>
//                   <DialogDescription>Complete follow-up history and client interactions</DialogDescription>
//                 </DialogHeader>

//                 {selectedClient && (
//                   <div className="space-y-6">
//                     <div className="grid grid-cols-2 gap-4">
//                       <div>
//                         <Label className="text-sm font-medium">Email</Label>
//                         <p className="text-sm text-gray-600 break-words">{selectedClient.email}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Assigned To</Label>
//                         <p className="text-sm text-gray-600">{selectedClient.assigned_to}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Current Stage</Label>
//                         <Badge className={getStageColor(selectedClient.stage)}>{selectedClient.stage}</Badge>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Closed</Label>
//                         <p className="text-sm text-gray-600">{formatDate(selectedClient.created_at)}</p>
//                       </div>
//                     </div>

//                     <div>
//                       <Label className="text-sm font-medium mb-3 block">Follow-up History</Label>
//                       <div className="space-y-3 max-h-64 overflow-y-auto">
//                         {callHistory.length > 0 ? (
//                           callHistory.map((entry, index) => (
//                             <div key={index} className="p-3 bg-gray-50 rounded-lg">
//                               <div className="flex items-center gap-2 mb-2">
//                                 <Calendar className="h-4 w-4 text-gray-500" />
//                                 <span className="text-sm font-medium">{entry.followup_date}</span>
//                               </div>
//                               <div className="mb-2">
//                                 <span className="text-sm font-medium">Stage: </span>
//                                 <Badge className={getStageColor(entry.current_stage)}>{entry.current_stage}</Badge>
//                               </div>
//                               <p className="text-sm text-gray-600 whitespace-pre-wrap">{entry.notes}</p>
//                             </div>
//                           ))
//                         ) : (
//                           <p className="text-sm text-gray-600">No follow-up history available.</p>
//                         )}
//                       </div>
//                     </div>

//                     {clientFeedback && (
//                       <div>
//                         <Label className="text-sm font-medium mb-3 block">Latest Feedback</Label>
//                         <div className="p-3 bg-blue-50 rounded-lg space-y-2">
//                           <div className="flex items-center justify-between">
//                             <div className="flex items-center gap-2">
//                               <span className="text-sm font-medium">Rating:</span>
//                               <div className="flex">{renderStars(clientFeedback.rating)}</div>
//                             </div>
//                             <Badge variant={clientFeedback.isHappy ? "default" : "secondary"}>
//                               {clientFeedback.isHappy ? "Happy" : "Needs Attention"}
//                             </Badge>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Will Renew: </span>
//                             <span className={`text-sm ${clientFeedback.willRenew ? "text-green-600" : "text-red-600"}`}>
//                               {clientFeedback.willRenew ? "Yes" : "No"}
//                             </span>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Notes: </span>
//                             <p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">{clientFeedback.notes}</p>
//                           </div>
//                           <div className="text-xs text-gray-500">Feedback Date: {clientFeedback.date}</div>
//                         </div>
//                       </div>
//                     )}
//                   </div>
//                 )}
//               </DialogContent>
//             </Dialog>

//             {/* FEEDBACK DIALOG */}
//             <Dialog open={feedbackDialogOpen} onOpenChange={onFeedbackDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Client Feedback</DialogTitle>
//                   <DialogDescription>Collect feedback from {selectedClient?.client_name}</DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Is Client Happy?</Label>
//                     <Select
//                       value={feedbackForm.isHappy ? "happy" : "unhappy"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, isHappy: value === "happy" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="happy">Happy</SelectItem>
//                         <SelectItem value="unhappy">Unhappy</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Rating (1-5)</Label>
//                     <Select
//                       value={String(feedbackForm.rating)}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, rating: Number(value) }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         {[1, 2, 3, 4, 5].map((rating) => (
//                           <SelectItem key={rating} value={String(rating)}>
//                             <div className="flex items-center gap-2">
//                               <span>{rating}</span>
//                               <div className="flex">{renderStars(rating)}</div>
//                             </div>
//                           </SelectItem>
//                         ))}
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label>Notes</Label>
//                     <Textarea
//                       placeholder="Enter detailed feedback..."
//                       value={feedbackForm.notes}
//                       onChange={(e) => setFeedbackForm((prev) => ({ ...prev, notes: e.target.value }))}
//                     />
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Will Client Renew?</Label>
//                     <Select
//                       value={feedbackForm.willRenew ? "yes" : "no"}
//                       onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, willRenew: value === "yes" }))}
//                     >
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="yes">Yes</SelectItem>
//                         <SelectItem value="no">No</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFeedbackDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFeedbackSubmit}>Save Feedback</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* FOLLOW-UP DIALOG */}
//             <Dialog open={followUpDialogOpen} onOpenChange={onFollowUpDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Schedule Follow-up</DialogTitle>
//                 </DialogHeader>
//                 <div className="space-y-4">
//                   <div>
//                     <Label className="block mb-1">Follow-up Date</Label>
//                     <Input
//                       type="date"
//                       value={followUpForm.date}
//                       onChange={(e) => setFollowUpForm((f) => ({ ...f, date: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                   <div>
//                     <Label className="block mb-1">Notes</Label>
//                     <Textarea
//                       placeholder="Add notes..."
//                       value={followUpForm.notes}
//                       onChange={(e) => setFollowUpForm((f) => ({ ...f, notes: e.target.value }))}
//                       className="w-full"
//                     />
//                   </div>
//                 </div>
//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFollowUpDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFollowUpSave}>Save Follow-up</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* CSV UPLOAD */}
//             <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>
//               <DialogContent className="max-w-5xl">
//                 <DialogHeader>
//                   <DialogTitle>Upload Sale Done CSV</DialogTitle>
//                   <DialogDescription>
//                     Upload your sales CSV. We'll parse and show the number of entries.
//                     <br />
//                     Required columns:
//                     <br />
//                     <code>lead_id, Name, Rate, Payment Frequency, sale_done, Onboarded date, Phone number, email</code>
//                     <br />
//                     Dates must be <code>yyyy-mm-dd</code>.
//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Input
//                     type="file"
//                     accept=".csv"
//                     onChange={(e) => {
//                       const file = e.target.files?.[0];
//                       if (file) {
//                         setCsvFile(file);
//                         handleCSVUpload(file);
//                       }
//                     }}
//                   />
//                   <p className="text-sm text-gray-600">
//                     {csvData.length > 0 ? `‚úÖ Detected ${csvData.length} records in file.` : "No file parsed yet."}
//                   </p>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setUploadDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleCSVSubmit} disabled={csvData.length === 0}>
//                     Submit to Supabase
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* BULK ASSIGN DIALOG */}
//             <Dialog open={bulkDialogOpen} onOpenChange={setBulkDialogOpen}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Bulk Assign to Accounts Associate</DialogTitle>
//                   <DialogDescription>
//                     {selectedIds.size} selected {selectedIds.size === 1 ? "client" : "clients"}
//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Label className="text-sm font-medium">Select Accounts Associate</Label>
//                   <Select
//                     value={selectedAssociateEmail}
//                     onValueChange={(v) => setSelectedAssociateEmail(v)}
//                   >
//                     <SelectTrigger>
//                       <SelectValue placeholder="Choose associate..." />
//                     </SelectTrigger>
//                     <SelectContent>
//                       {associates.map((a) => (
//                         <SelectItem key={a.email} value={a.email}>
//                           {a.name} ‚Äî {a.email}
//                         </SelectItem>
//                       ))}
//                     </SelectContent>
//                   </Select>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setBulkDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button disabled={!selectedAssociateEmail} onClick={doBulkAssign}>
//                     Assign
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>
//           </div>
//         </DashboardLayout>
//       </ProtectedRoute>
//     </>
//   );
// }





// // app/account-management/page.tsx
// "use client";

// import * as React from "react";
// import { useEffect, useMemo, useRef, useState } from "react";
// import { supabase } from "@/utils/supabase/client";
// import { DashboardLayout } from "@/components/layout/dashboard-layout";
// import { Button } from "@/components/ui/button";
// import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
// import { Badge } from "@/components/ui/badge";
// import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
// import { Dialog, DialogContent, DialogFooter, DialogHeader, DialogTitle, DialogDescription } from "@/components/ui/dialog";
// import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
// import { Input } from "@/components/ui/input";
// import { Label } from "@/components/ui/label";
// import { Textarea } from "@/components/ui/textarea";
// import { Tabs, TabsList, TabsTrigger } from "@/components/ui/tabs";
// import { Eye, MessageSquare, Star, Calendar } from "lucide-react";
// import ProtectedRoute from "@/components/auth/ProtectedRoute";
// import Papa from "papaparse";
// import FullScreenLoader from "@/components/ui/FullScreenLoader";

// /** =========================
//  *  Config ‚Äî using your new columns
//  *  ========================= */
// const ACCOUNT_EMAIL_COL = "account_assigned_email";
// const ACCOUNT_NAME_COL = "account_assigned_name";
// const ALL_OWNERS = "__ALL_OWNERS__";

// type AccountStage = "DNP" | "Call Again" | "Conversation Done";

// interface FollowUp {
//   date: string;
//   notes: string;
// }

// interface Feedback {
//   isHappy: boolean;
//   rating: number;
//   notes: string;
//   willRenew: boolean;
//   date: string; // yyyy-mm-dd
// }

// interface Client {
//   id: string;
//   client_name: string;
//   email: string;
//   phone?: string | null;
//   assigned_to: string; // from leads
//   account_assigned_name?: string | null; // from sales_closure
//   account_assigned_email?: string | null; // from sales_closure
//   stage: AccountStage;
//   created_at: string;
//   follow_ups?: FollowUp[];
//   feedback?: Feedback;
// }

// const accountStages: AccountStage[] = ["DNP", "Call Again", "Conversation Done"];

// const getStageColor = (stage: AccountStage) => {
//   switch (stage) {
//     case "DNP":
//       return "bg-yellow-100 text-yellow-800";
//     case "Call Again":
//       return "bg-blue-100 text-blue-800";
//     case "Conversation Done":
//       return "bg-green-100 text-green-800";
//     default:
//       return "bg-gray-100 text-gray-800";
//   }
// };

// const formatDate = (dateString: string | undefined): string => {
//   if (!dateString) return "N/A";
//   const d = new Date(dateString);
//   return isNaN(d.getTime()) ? "N/A" : d.toLocaleDateString();
// };

// function renderStars(rating: number) {
//   return (
//     <span className="flex">
//       {Array.from({ length: 5 }, (_, i) => (
//         <Star key={i} className={`h-4 w-4 ${i < rating ? "fill-current text-yellow-400" : "text-gray-300"}`} />
//       ))}
//     </span>
//   );
// }

// const isAssigned = (name?: string | null) => !!(name && String(name).trim().length > 0);

// export default function AccountManagementPage() {
//   const [clients, setClients] = useState<Client[]>([]);
//   const [pageLoading, setPageLoading] = useState(false);

//   // Logged-in user meta
//   const [me, setMe] = useState<{ email: string; name: string; role: string }>({
//     email: "",
//     name: "",
//     role: "",
//   });

//   // Role helpers
//   const isAssociate = me.role === "Accounts Associate";
//   // Default permissive until role is known, so Super Admin sees tools immediately
//   const canAssign = me.role ? me.role === "Super Admin" || me.role === "Account Management" : true;

//   const [selectedClient, setSelectedClient] = useState<Client | null>(null);
//   const [historyDialogOpen, setHistoryDialogOpen] = useState(false);
//   const [feedbackDialogOpen, setFeedbackDialogOpen] = useState(false);
//   const [followUpDialogOpen, setFollowUpDialogOpen] = useState(false);

//   const [searchTerm, setSearchTerm] = useState("");
//   const [followUpFilter, setFollowUpFilter] = useState<"All dates" | "Today">("All dates");
//   const [sortKey, setSortKey] = useState<"client_name" | "created_at" | null>(null);
//   const [sortOrder, setSortOrder] = useState<"asc" | "desc">("asc");

//   const [feedbackForm, setFeedbackForm] = useState<Feedback>({
//     isHappy: false,
//     rating: 5,
//     notes: "",
//     willRenew: false,
//     date: new Date().toISOString().split("T")[0],
//   });
//   const [followUpForm, setFollowUpForm] = useState<FollowUp>({ date: "", notes: "" });

//   const [pendingStage, setPendingStage] = useState<AccountStage | null>(null);
//   const prevStageRef = useRef<AccountStage | null>(null);
//   const changeCommittedRef = useRef<boolean>(false);

//   const [callHistory, setCallHistory] = useState<any[]>([]);
//   const [clientFeedback, setClientFeedback] = useState<Feedback | null>(null);

//   const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
//   const [_csvFile, setCsvFile] = useState<File | null>(null);
//   const [csvData, setCsvData] = useState<any[]>([]);

//   /** BULK selection + assignment */
//   const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
//   const [bulkDialogOpen, setBulkDialogOpen] = useState(false);
//   const [associates, setAssociates] = useState<{ name: string; email: string }[]>([]);
//   const [selectedAssociateEmail, setSelectedAssociateEmail] = useState<string>("");

//   /** Tabs + owner filter (assigned tab) */
//   const [activeTab, setActiveTab] = useState<"unassigned" | "assigned">("unassigned");
//   const [ownerFilter, setOwnerFilter] = useState<string>(ALL_OWNERS);

//   /** ===== Current user (role/email/name) ===== */
//   useEffect(() => {
//     let canceled = false;
//     (async () => {
//       try {
//         const { data: auth } = await supabase.auth.getUser();
//         const user = auth?.user;
//         if (!user) return;

//         const { data, error } = await supabase
//           .from("profiles")
//           .select("full_name, user_email, roles")
//           .eq("auth_id", user.id)
//           .single();

//         if (!canceled) {
//           setMe({
//             email: (data?.user_email || user.email || "").trim(),
//             name: (data?.full_name || "").trim(),
//             role: (data?.roles || "").trim(),
//           });
//         }
//         if (error) console.error("profiles fetch error:", error);
//       } catch (e) {
//         console.error("Failed to load current profile:", e);
//       }
//     })();
//     return () => {
//       canceled = true;
//     };
//   }, []);

//   /** ===== Initial load (depends on role to apply associate filter) ===== */
//   useEffect(() => {
//     let cancelled = false;

//     const fetchClients = async () => {
//       setPageLoading(true);
//       try {
//         // include new columns from sales_closure
//         const { data: rawSalesData, error: salesError } = await supabase
//           .from("sales_closure")
//           .select("lead_id, email, onboarded_date, account_assigned_email, account_assigned_name")
//           .not("onboarded_date", "is", null)
//           .order("onboarded_date", { ascending: false });

//         if (salesError || !rawSalesData) {
//           console.error("‚ùå sales_closure fetch failed", salesError);
//           return;
//         }

//         const salesDataMap = new Map<
//           string,
//           {
//             lead_id: string;
//             email: string;
//             onboarded_date: string;
//             account_assigned_email: string | null;
//             account_assigned_name: string | null;
//           }
//         >();
//         for (const row of rawSalesData) {
//           if (!salesDataMap.has(row.lead_id)) {
//             salesDataMap.set(row.lead_id, {
//               lead_id: row.lead_id,
//               email: row.email,
//               onboarded_date: row.onboarded_date as any,
//               account_assigned_email: (row as any).account_assigned_email ?? null,
//               account_assigned_name: (row as any).account_assigned_name ?? null,
//             });
//           }
//         }
//         let salesData = Array.from(salesDataMap.values());

//         // If Accounts Associate, restrict to their own assigned rows
//         if (isAssociate) {
//           const meEmail = (me.email || "").toLowerCase();
//           const meName = (me.name || "").toLowerCase();

//           salesData = salesData.filter((r) => {
//             const hasEmail = !!(r.account_assigned_email && r.account_assigned_email.trim());
//             const hasName = !!(r.account_assigned_name && r.account_assigned_name.trim());
//             const emailMatch = (r.account_assigned_email || "").trim().toLowerCase() === meEmail;
//             const nameMatch = (r.account_assigned_name || "").trim().toLowerCase() === meName;

//             if (hasEmail && hasName) return emailMatch && nameMatch;
//             if (hasEmail) return emailMatch;
//             if (hasName) return nameMatch;
//             return false;
//           });
//         }

//         const leadIds = salesData.map((s) => s.lead_id);
//         if (leadIds.length === 0) {
//           if (!cancelled) setClients([]);
//           return;
//         }

//         const { data: leadsData, error: leadsError } = await supabase
//           .from("leads")
//           .select("business_id, name, phone, assigned_to, email")
//           .in("business_id", leadIds);

//         if (leadsError || !leadsData) {
//           console.error("‚ùå leads fetch failed", leadsError);
//           return;
//         }
//         const leadsMap = Object.fromEntries(leadsData.map((l) => [l.business_id, l]));

//         const { data: callRaw, error: callError } = await supabase
//           .from("call_history")
//           .select("lead_id, current_stage, followup_date")
//           .order("followup_date", { ascending: false });
//         if (callError) console.error("‚ùå call_history fetch failed", callError);

//         const latestCallMap: Record<string, any> = {};
//         for (const call of callRaw || []) {
//           if (!latestCallMap[call.lead_id]) latestCallMap[call.lead_id] = call;
//         }

//         const { data: feedbackRows, error: fbErr } = await supabase
//           .from("client_feedback")
//           .select("lead_id, client_emotion, rating, notes, renew_status, id")
//           .in("lead_id", leadIds)
//           .order("id", { ascending: false });
//         if (fbErr) console.error("‚ö†Ô∏è client_feedback fetch failed", fbErr);

//         const latestFbMap = new Map<string, Feedback>();
//         for (const r of feedbackRows || []) {
//           if (!latestFbMap.has(r.lead_id)) {
//             latestFbMap.set(r.lead_id, {
//               isHappy: r.client_emotion === "happy",
//               rating: parseInt(String(r.rating || "0"), 10),
//               notes: r.notes || "",
//               willRenew: r.renew_status === "yes",
//               date: new Date().toISOString().split("T")[0],
//             });
//           }
//         }

//         const merged: Client[] = salesData.map((sale) => {
//           const lead = leadsMap[sale.lead_id] || {};
//           const call = latestCallMap[sale.lead_id];
//           return {
//             id: sale.lead_id,
//             client_name: lead.name || "Unnamed",
//             email: sale.email || lead.email || "unknown@example.com",
//             phone: lead.phone ?? null,
//             assigned_to: lead.assigned_to || "Unassigned",
//             created_at: sale.onboarded_date,
//             stage: (call?.current_stage as AccountStage) || "DNP",
//             follow_ups: [],
//             feedback: latestFbMap.get(sale.lead_id),
//             account_assigned_name: sale.account_assigned_name,
//             account_assigned_email: sale.account_assigned_email,
//           };
//         });

//         if (!cancelled) setClients(merged);
//       } catch (err) {
//         console.error("‚ùå Unexpected error:", err);
//       } finally {
//         if (!cancelled) setPageLoading(false);
//       }
//     };

//     fetchClients();
//   }, [me.role, me.email, me.name, isAssociate]);

//   // If associate, force Assigned tab
//   useEffect(() => {
//     if (isAssociate) setActiveTab("assigned");
//   }, [isAssociate]);

//   /** ===== History & feedback fetch for selected client ===== */
//   useEffect(() => {
//     if (!historyDialogOpen || !selectedClient) {
//       setCallHistory([]);
//       setClientFeedback(null);
//       return;
//     }

//     const fetchCallHistoryAndFeedback = async () => {
//       const { data: callHistoryData, error: callHistoryError } = await supabase
//         .from("call_history")
//         .select("current_stage, followup_date, notes")
//         .eq("lead_id", selectedClient.id)
//         .order("followup_date", { ascending: false });

//       if (callHistoryError) {
//         console.error(`Error fetching call history for lead ${selectedClient.id}:`, JSON.stringify(callHistoryError, null, 2));
//       } else {
//         setCallHistory(callHistoryData || []);
//       }

//       const { data: feedbackData, error: feedbackError } = await supabase
//         .from("client_feedback")
//         .select("client_emotion, rating, notes, renew_status, id")
//         .eq("lead_id", selectedClient.id)
//         .order("id", { ascending: false })
//         .limit(1);

//       if (feedbackError) {
//         console.error(`Error fetching client feedback for lead ${selectedClient.id}:`, JSON.stringify(feedbackError, null, 2));
//       } else if (feedbackData?.[0]) {
//         const row = feedbackData[0];
//         setClientFeedback({
//           isHappy: row.client_emotion === "happy",
//           rating: parseInt(String(row.rating || "0"), 10),
//           notes: row.notes || "",
//           willRenew: row.renew_status === "yes",
//           date: new Date().toISOString().split("T")[0],
//         });
//       }
//     };

//     fetchCallHistoryAndFeedback();
//   }, [historyDialogOpen, selectedClient]);

//   /** ===== Base filter by search and the 15-day "Today" chip ===== */
//   const baseFiltered = useMemo(() => {
//     const term = searchTerm.trim().toLowerCase();
//     const bySearch = (c: Client) =>
//       c.email.toLowerCase().includes(term) ||
//       c.client_name.toLowerCase().includes(term) ||
//       (c.phone ?? "").toString().toLowerCase().includes(term);

//     if (followUpFilter === "Today") {
//       const today = new Date();
//       return clients.filter((client) => {
//         const createdAt = new Date(client.created_at);
//         const diffInDays = Math.floor((today.getTime() - createdAt.getTime()) / 86400000);
//         return diffInDays === 15 && bySearch(client);
//       });
//     }
//     return clients.filter(bySearch);
//   }, [clients, searchTerm, followUpFilter]);

//   /** ===== Tab filtering ===== */
//   const tabFiltered = useMemo(() => {
//     if (activeTab === "unassigned") {
//       return baseFiltered.filter((c) => !isAssigned(c.account_assigned_name));
//     } else {
//       let arr = baseFiltered.filter((c) => isAssigned(c.account_assigned_name));
//       if (ownerFilter !== ALL_OWNERS && canAssign) {
//         arr = arr.filter((c) => (c.account_assigned_name || "").trim() === ownerFilter);
//       }
//       return arr;
//     }
//   }, [baseFiltered, activeTab, ownerFilter, canAssign]);

//   /** ===== Sorting ===== */
//   const sortedClients = useMemo(() => {
//     if (!sortKey) return tabFiltered;
//     const arr = [...tabFiltered];
//     if (sortKey === "created_at") {
//       arr.sort((a, b) => {
//         const da = new Date(a.created_at).getTime();
//         const db = new Date(b.created_at).getTime();
//         return sortOrder === "asc" ? da - db : db - da;
//       });
//     } else if (sortKey === "client_name") {
//       arr.sort((a, b) => {
//         const va = (a.client_name || "").toLowerCase();
//         const vb = (b.client_name || "").toLowerCase();
//         if (va === vb) return 0;
//         return sortOrder === "asc" ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
//       });
//     }
//     return arr;
//   }, [tabFiltered, sortKey, sortOrder]);

//   const handleSort = (key: "client_name" | "created_at") => {
//     if (sortKey === key) {
//       setSortOrder((prev) => (prev === "asc" ? "desc" : "asc"));
//     } else {
//       setSortKey(key);
//       setSortOrder("asc");
//     }
//   };

//   /** ===== Counts & owners ===== */
//   const assignedCountAll = useMemo(() => clients.filter((c) => isAssigned(c.account_assigned_name)).length, [clients]);
//   const unassignedCountAll = useMemo(() => clients.length - assignedCountAll, [clients, assignedCountAll]);

//   const ownerNames = useMemo(() => {
//     const s = new Set<string>();
//     clients.forEach((c) => {
//       const nm = (c.account_assigned_name || "").trim();
//       if (nm) s.add(nm);
//     });
//     return Array.from(s).sort((a, b) => a.localeCompare(b));
//   }, [clients]);

//   const ownerCount = useMemo(() => {
//     if (!canAssign || ownerFilter === ALL_OWNERS) return 0;
//     return clients.filter((c) => (c.account_assigned_name || "").trim() === ownerFilter).length;
//   }, [clients, ownerFilter, canAssign]);

//   /** ===== Deadline badge ===== */
//   const getRenewWithinBadge = (createdAt: string): React.ReactNode => {
//     if (!createdAt) return "-";
//     const closedDate = new Date(createdAt);
//     const today = new Date();
//     const diffInDays = Math.floor((today.getTime() - closedDate.getTime()) / 86400000);
//     if (diffInDays < 15) {
//       const daysLeft = 15 - diffInDays;
//       return <Badge className="bg-green-100 text-green-800">Within {daysLeft} day{daysLeft === 1 ? "" : "s"}</Badge>;
//     } else if (diffInDays === 15) {
//       return <Badge className="bg-yellow-100 text-gray-800">Today lastdate</Badge>;
//     } else {
//       const overdueDays = diffInDays - 15;
//       return <Badge className="bg-red-100 text-red-800">Overdue by {overdueDays} day{overdueDays === 1 ? "" : "s"}</Badge>;
//     }
//   };

//   /** ===== Stage transitions (existing) ===== */
//   const handleStageUpdate = (clientId: string, newStage: AccountStage) => {
//     const current = clients.find((c) => c.id === clientId);
//     if (!current) return;
//     prevStageRef.current = current.stage;
//     changeCommittedRef.current = false;

//     setClients((prev) => prev.map((c) => (c.id === clientId ? { ...c, stage: newStage } : c)));
//     const clientWithUpdatedStage = { ...current, stage: newStage };
//     setSelectedClient(clientWithUpdatedStage);

//     if (newStage === "Conversation Done") {
//       setFeedbackForm({
//         isHappy: false,
//         rating: 5,
//         notes: "",
//         willRenew: false,
//         date: new Date().toISOString().split("T")[0],
//       });
//       setFeedbackDialogOpen(true);
//     } else {
//       setPendingStage(newStage);
//       setFollowUpForm({
//         date: new Date().toISOString().split("T")[0],
//         notes: "",
//       });
//       setFollowUpDialogOpen(true);
//     }
//   };
//   const onFollowUpDialogOpenChange = (open: boolean) => {
//     setFollowUpDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       setClients((prev) => prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c)));
//       setPendingStage(null);
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };
//   const onFeedbackDialogOpenChange = (open: boolean) => {
//     setFeedbackDialogOpen(open);
//     if (!open && !changeCommittedRef.current && selectedClient && prevStageRef.current) {
//       setClients((prev) => prev.map((c) => (c.id === selectedClient.id ? { ...c, stage: prevStageRef.current! } : c)));
//       prevStageRef.current = null;
//     }
//     if (!open) changeCommittedRef.current = false;
//   };

//   const handleFeedbackSubmit = async () => {
//     if (!selectedClient) {
//       alert("No client selected.");
//       return;
//     }
//     if (!feedbackForm.rating || feedbackForm.rating < 1 || feedbackForm.rating > 5) {
//       alert("Please select a valid rating between 1 and 5.");
//       return;
//     }
//     if (!feedbackForm.notes || feedbackForm.notes.trim() === "") {
//       alert("Please provide feedback notes.");
//       return;
//     }

//     const emailToUse = !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse = !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const { data: leadCheck, error: leadCheckError } = await supabase
//       .from("leads")
//       .select("business_id")
//       .eq("business_id", selectedClient.id)
//       .limit(1);
//     if (leadCheckError || !leadCheck || leadCheck.length === 0) {
//       alert("Lead does not exist. Please create the lead first.");
//       return;
//     }

//     const feedbackRow = {
//       lead_id: selectedClient.id,
//       client_emotion: feedbackForm.isHappy ? "happy" : "unhappy",
//       rating: feedbackForm.rating.toString(),
//       notes: feedbackForm.notes.trim(),
//       renew_status: feedbackForm.willRenew ? "yes" : "no",
//       email: emailToUse,
//     };
//     const { error: fbErr } = await supabase.from("client_feedback").insert([feedbackRow]);
//     if (fbErr) {
//       console.error("Error saving feedback:", fbErr);
//       alert(`Failed to save feedback: ${fbErr.message}`);
//       return;
//     }

//     const { error: chErr } = await supabase.from("call_history").insert([
//       {
//         lead_id: selectedClient.id,
//         current_stage: "Conversation Done",
//         followup_date: feedbackForm.date,
//         notes: `Feedback recorded: rating ${feedbackForm.rating}/5. ${feedbackForm.notes}`.slice(0, 1000),
//         assigned_to: selectedClient.assigned_to || "Unassigned",
//         email: emailToUse,
//         phone: phoneToUse,
//       },
//     ]);
//     if (chErr) console.error("Error writing call_history for Conversation Done:", chErr);

//     setClients((prev) =>
//       prev.map((c) => (c.id === selectedClient.id ? { ...c, feedback: feedbackForm, stage: "Conversation Done" } : c))
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFeedbackDialogOpen(false);
//     setFeedbackForm({ isHappy: false, rating: 5, notes: "", willRenew: false, date: new Date().toISOString().split("T")[0] });
//   };

//   const handleFollowUpSave = async () => {
//     if (!selectedClient || !pendingStage) {
//       alert("No client or stage selected.");
//       return;
//     }
//     if (!followUpForm.date || !followUpForm.notes.trim()) {
//       alert("Please provide a follow-up date and notes.");
//       return;
//     }

//     const emailToUse = !selectedClient.email || selectedClient.email.trim() === "" ? "unknown@example.com" : selectedClient.email;
//     const phoneToUse = !selectedClient.phone || String(selectedClient.phone).trim() === "" ? null : String(selectedClient.phone);

//     const followUpData = {
//       lead_id: selectedClient.id,
//       current_stage: pendingStage,
//       followup_date: followUpForm.date,
//       notes: followUpForm.notes.trim(),
//       assigned_to: selectedClient.assigned_to || "Unassigned",
//       email: emailToUse,
//       phone: phoneToUse,
//     };

//     const { error } = await supabase.from("call_history").insert([followUpData]);
//     if (error) {
//       console.error("Error saving follow-up:", error);
//       alert("Failed to save follow-up. Please try again.");
//       return;
//     }

//     setClients((prev) =>
//       prev.map((client) =>
//         client.id === selectedClient.id
//           ? {
//               ...client,
//               stage: pendingStage,
//               follow_ups: [...(client.follow_ups || []), { date: followUpForm.date, notes: followUpForm.notes }],
//             }
//           : client
//       )
//     );

//     changeCommittedRef.current = true;
//     prevStageRef.current = null;
//     setFollowUpDialogOpen(false);
//     setFollowUpForm({ date: "", notes: "" });
//     setPendingStage(null);
//   };

//   /** ===== CSV upload ===== */
//   const handleCSVUpload = (file: File) => {
//     Papa.parse(file, {
//       header: true,
//       skipEmptyLines: true,
//       complete: function (results) {
//         const requiredFields = ["lead_id", "Name", "Rate", "Payment Frequency", "sale_done", "Onboarded date", "Phone number", "email"];
//         const fields: string[] = Array.isArray(results.meta.fields) ? (results.meta.fields as string[]) : [];
//         const missingFields = requiredFields.filter((f) => !fields.includes(f));
//         if (missingFields.length > 0) {
//           alert(`Missing required columns: ${missingFields.join(", ")}`);
//           return;
//         }
//         setCsvData(results.data as any[]);
//       },
//       error: function (error) {
//         console.error("CSV parsing error:", error);
//         alert("Failed to parse CSV.");
//       },
//     });
//   };

//   const handleCSVSubmit = async () => {
//     if (csvData.length === 0) {
//       alert("No CSV data to submit");
//       return;
//     }

//     try {
//       const salesToInsert: any[] = [];

//       for (const row of csvData) {
//         const lead_id = row["lead_id"]?.trim?.();
//         const name = row["Name"]?.trim?.();
//         const email = row["email"]?.trim?.();
//         const sale_value = parseFloat(row["Rate"]);
//         const subscription_cycle = parseInt(row["Payment Frequency"], 10);
//         const date = new Date(row["Onboarded date"]);
//         const sale_done = new Date(row["sale_done"]);

//         if (!lead_id || !name || !email || !sale_value || !subscription_cycle || isNaN(date.getTime()) || isNaN(sale_done.getTime())) {
//           console.warn("‚ùå Skipping invalid row:", row);
//           continue;
//         }

//         salesToInsert.push({
//           lead_id,
//           lead_name: name,
//           email,
//           sale_value,
//           subscription_cycle,
//           payment_mode: "UPI",
//           finance_status: "Paid",
//           closed_at: sale_done.toISOString(),
//           onboarded_date: date.toISOString().split("T")[0],
//         });
//       }

//       if (salesToInsert.length === 0) {
//         alert("No valid rows to upload.");
//         return;
//       }

//       const { error } = await supabase.from("sales_closure").insert(salesToInsert);
//       if (error) throw error;

//       alert(`üéâ Successfully inserted ${salesToInsert.length} renewal records into sales_closure`);
//       setUploadDialogOpen(false);
//       setCsvData([]);
//       setCsvFile(null);
//     } catch (err: any) {
//       console.error("‚ùå Upload failed:", err);
//       alert(`Upload failed: ${err?.message || String(err)}`);
//     }
//   };

//   /** ===== Dashboard aggregates ===== */
//   const happyCount = useMemo(() => clients.reduce((acc, c) => (c.feedback?.isHappy ? acc + 1 : acc), 0), [clients]);
//   const willRenewCount = useMemo(() => clients.reduce((acc, c) => (c.feedback?.willRenew ? acc + 1 : acc), 0), [clients]);
//   const avgRating = useMemo(() => {
//     const fb = clients.map((c) => c.feedback).filter(Boolean) as Feedback[];
//     if (fb.length === 0) return "N/A";
//     const mean = fb.reduce((s, f) => s + (f.rating || 0), 0) / fb.length;
//     return mean.toFixed(1);
//   }, [clients]);

//   /** ===== Bulk helpers ===== */
//   const toggleOne = (id: string) => {
//     const row = sortedClients.find((c) => c.id === id);
//     if (row && isAssigned(row.account_assigned_name)) return;
//     setSelectedIds((prev) => {
//       const next = new Set(prev);
//       if (next.has(id)) next.delete(id);
//       else next.add(id);
//       return next;
//     });
//   };

//   const quickSelect = (n: number) => {
//     const eligible = sortedClients.filter((c) => !isAssigned(c.account_assigned_name));
//     const firstN = eligible.slice(0, n).map((c) => c.id);
//     setSelectedIds(new Set(firstN));
//   };

//   const clearSelection = () => setSelectedIds(new Set());

//   // Clear selection when switching to Assigned tab
//   useEffect(() => {
//     if (activeTab === "assigned") clearSelection();
//   }, [activeTab]);

//   const openBulkDialog = async () => {
//     if (selectedIds.size === 0) return;
//     setBulkDialogOpen(true);
//     const { data, error } = await supabase
//       .from("profiles")
//       .select("full_name, user_email, roles")
//       .eq("roles", "Accounts Associate");
//     if (error) {
//       console.error("Failed to load Accounts Associates:", error);
//       return;
//     }
//     setAssociates(
//       (data || [])
//         .map((r) => ({
//           name: (r.full_name || "").trim() || (r.user_email || "").trim(),
//           email: (r.user_email || "").trim(),
//         }))
//         .filter((a) => a.email.length > 0)
//         .sort((a, b) => a.name.localeCompare(b.name))
//     );
//   };

//   const doBulkAssign = async () => {
//     if (!selectedAssociateEmail) {
//       alert("Choose an Accounts Associate.");
//       return;
//     }
//     const picked = associates.find((a) => a.email === selectedAssociateEmail);
//     if (!picked) {
//       alert("Invalid associate.");
//       return;
//     }
//     const leadIds = Array.from(selectedIds);
//     if (leadIds.length === 0) return;

//     const payload: Record<string, any> = {};
//     payload[ACCOUNT_EMAIL_COL] = picked.email;
//     payload[ACCOUNT_NAME_COL] = picked.name;

//     const { error } = await supabase.from("sales_closure").update(payload).in("lead_id", leadIds);
//     if (error) {
//       console.error("Bulk assign failed:", error);
//       alert("Bulk assign failed. Check permissions/RLS.");
//       return;
//     }

//     setClients((prev) =>
//       prev.map((c) => (selectedIds.has(c.id) ? { ...c, account_assigned_name: picked.name, account_assigned_email: picked.email } : c))
//     );

//     setBulkDialogOpen(false);
//     setSelectedAssociateEmail("");
//     clearSelection();
//     setActiveTab("assigned");
//   };


  
//   return (
//     <>
//       {pageLoading && <FullScreenLoader />}
//       {/* Allow all three roles into the page */}
//       <ProtectedRoute allowedRoles={["Account Management", "Super Admin", "Accounts Associate"]}>
//         <DashboardLayout>
//           <div className="space-y-6">
//             <div className="flex justify-between items-center">
//               <div>
//                 <h1 className="text-3xl font-bold text-gray-900">Account Management CRM</h1>
//                 <p className="text-gray-600 mt-2">Manage client relationships and feedback</p>
//               </div>

//               <div className="flex items-center gap-2">
//                 {/* CSV only for Admin/Account Management */}
//                 { activeTab === "unassigned" && <Button onClick={() => setUploadDialogOpen(true)}>Upload Sale Done CSV</Button>}
//               </div>
//             </div>

//             {/* Summary cards */}
//             <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Total Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{clients.length}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Happy Clients</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{happyCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Renewal Intent</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{willRenewCount}</div>
//                 </CardContent>
//               </Card>
//               <Card>
//                 <CardHeader className="pb-2">
//                   <CardTitle className="text-sm font-medium">Avg Rating</CardTitle>
//                 </CardHeader>
//                 <CardContent>
//                   <div className="text-2xl font-bold">{avgRating}</div>
//                 </CardContent>
//               </Card>
//             </div>

//             <Card>
//               <CardHeader>
//                 <div className="flex items-center justify-between">
//                   <div>
//                     <CardTitle>Account Management Dashboard</CardTitle>
//                     <CardDescription>Manage client accounts and track feedback</CardDescription>
//                   </div>

//                   {/* Right side header controls */}
//                   <div className="flex items-center gap-3">
//                     {canAssign ? (
//                       <>
//                         {/* Owner filter only in Assigned tab */}
//                         {activeTab === "assigned" && (
//                           <div className="flex items-center gap-2">
//                             <span className="text-sm text-gray-600">Owner:</span>
//                             <Select value={ownerFilter} onValueChange={setOwnerFilter}>
//                               <SelectTrigger className="w-56">
//                                 <SelectValue placeholder="All owners" />
//                               </SelectTrigger>
//                               <SelectContent>
//                                 <SelectItem value={ALL_OWNERS}>All owners</SelectItem>
//                                 {ownerNames.map((nm) => (
//                                   <SelectItem key={nm} value={nm}>
//                                     {nm}
//                                   </SelectItem>
//                                 ))}
//                               </SelectContent>
//                             </Select>
//                             {ownerFilter !== ALL_OWNERS && (
//                               <span className="text-sm text-gray-600">
//                                 Count: <b>{ownerCount}</b>
//                               </span>
//                             )}
//                           </div>
//                         )}

//                         {/* Tabs for admins */}
//                         <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)}>
//                           <TabsList>
//                             <TabsTrigger value="unassigned">Unassigned ({unassignedCountAll})</TabsTrigger>
//                             <TabsTrigger value="assigned">Assigned ({assignedCountAll})</TabsTrigger>
//                           </TabsList>
//                         </Tabs>
//                       </>
//                     ) :  (
//                       // Associates see only their assigned leads
//                       <Badge variant="secondary">Assigned to you ({assignedCountAll})</Badge>
//                     )}
//                   </div>
//                 </div>
//               </CardHeader>

//               <CardContent>
//                 <div className="flex items-center justify-between mt-4">
//                   <div className="flex items-center gap-3">
//                     <Input
//                       placeholder="Search by email, name, or phone"
//                       value={searchTerm}
//                       onChange={(e) => setSearchTerm(e.target.value)}
//                       className="max-w-3xl"
//                     />
//                   </div>

//                   <div className="flex items-center gap-2">
//                     {/* Quick select & Bulk assign only for admins on Unassigned tab */}
//                     {activeTab === "unassigned" && (
//                       <div className="hidden md:flex items-center gap-2 mr-2">
//                         <span className="text-sm text-gray-600">Select first:</span>
//                         {[10, 20, 40, 50].map((n) => (
//                           <Button key={n} size="sm" variant="outline" onClick={() => quickSelect(n)}>
//                             {n}
//                           </Button>
//                         ))}
//                         <Button size="sm" variant="ghost" onClick={clearSelection}>
//                           Clear
//                         </Button>
//                       </div>
//                     )}

//                     {activeTab === "unassigned" && (
//                       <Button
//                         variant="default"
//                         disabled={selectedIds.size === 0}
//                         onClick={openBulkDialog}
//                         title={selectedIds.size ? `Bulk assign ${selectedIds.size} selected` : "Select rows first"}
//                       >
//                         Bulk Assign
//                       </Button>
//                     )}

//                     <Select value={followUpFilter} onValueChange={(v) => setFollowUpFilter(v as "All dates" | "Today")}>
//                       <SelectTrigger className="w-40">
//                         <SelectValue placeholder="Follow Up" />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="All dates">All dates</SelectItem>
//                         <SelectItem value="Today">Due today (15th day)</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>
//                 </div>

//                 <div className="text-sm text-gray-500 mt-2">
//                   Showing <b>{sortedClients.length}</b> {activeTab} result{sortedClients.length === 1 ? "" : "s"}
//                   {activeTab === "assigned" && ownerFilter !== ALL_OWNERS ? (
//                     <>
//                       {" "}
//                       for <b>{ownerFilter}</b>
//                     </>
//                   ) : null}
//                 </div>

//                 <div className="rounded-md border mt-4">
//                   <Table>
//                     <TableHeader>
//                       <TableRow>
//                         <TableHead className="w-10">S.No</TableHead>
//                         {/* Checkbox header only when admins & unassigned tab */}
//                         {activeTab === "unassigned" && <TableHead className="w-8">Select</TableHead>}

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Client Name</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("desc");
//                               }}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "client_name" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("client_name");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Email</TableHead>
//                         <TableHead>Phone</TableHead>
//                         <TableHead>Assigned To</TableHead>
//                         <TableHead>Stage</TableHead>

//                         <TableHead className="select-none">
//                           <div className="flex items-center gap-2">
//                             <span>Closed At</span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "desc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => handleSort("created_at")}
//                             >
//                               ‚Üë
//                             </span>
//                             <span
//                               className={`cursor-pointer text-lg leading-none ${sortKey === "created_at" && sortOrder === "asc" ? "text-blue-500" : "text-gray-400"}`}
//                               onClick={() => {
//                                 setSortKey("created_at");
//                                 setSortOrder("asc");
//                               }}
//                             >
//                               ‚Üì
//                             </span>
//                           </div>
//                         </TableHead>

//                         <TableHead>Deadline</TableHead>
//                         <TableHead className="text-center">Account Owner</TableHead>
//                         <TableHead>Actions</TableHead>
//                       </TableRow>
//                     </TableHeader>
//                     <TableBody>
//                       {sortedClients.map((client, idx) => {
//                         const assigned = isAssigned(client.account_assigned_name);
//                         const checked = selectedIds.has(client.id);
//                         return (
//                           <TableRow key={`${client.id}-${idx}`}>
//                             <TableCell>{idx + 1}</TableCell>

//                             {/* Checkbox only if admins & UNASSIGNED tab & row is unassigned */}
//                             {activeTab === "unassigned" ? (
//                               <TableCell>
//                                 {!assigned ? (
//                                   <input
//                                     type="checkbox"
//                                     className="h-4 w-4"
//                                     checked={checked}
//                                     onChange={() => toggleOne(client.id)}
//                                     aria-label={`Select ${client.client_name}`}
//                                   />
//                                 ) : null}
//                               </TableCell>
//                             ) : null}

//                             <TableCell
//                               className="font-medium max-w-[180px] break-words whitespace-normal cursor-pointer text-blue-600 hover:underline"
//                               onClick={() => window.open(`/leads/${client.id}`, "_blank")}
//                             >
//                               {client.client_name}
//                             </TableCell>

//                             <TableCell className="max-w-[220px] break-words whitespace-normal">{client.email}</TableCell>
//                             <TableCell>{client.phone || "-"}</TableCell>
//                             <TableCell>{client.assigned_to}</TableCell>

//                             <TableCell>
//                               <Select value={accountStages.includes(client.stage) ? client.stage : undefined} onValueChange={(value: AccountStage) => handleStageUpdate(client.id, value)}>
//                                 <SelectTrigger className="w-44">
//                                   <SelectValue placeholder="Select Stage" />
//                                 </SelectTrigger>
//                                 <SelectContent>
//                                   {accountStages.map((stage) => (
//                                     <SelectItem key={stage} value={stage}>
//                                       <span className={`inline-flex px-2 py-1 rounded ${getStageColor(stage)}`}>{stage}</span>
//                                     </SelectItem>
//                                   ))}
//                                 </SelectContent>
//                               </Select>
//                             </TableCell>

//                             <TableCell>{formatDate(client.created_at)}</TableCell>
//                             <TableCell>{getRenewWithinBadge(client.created_at)}</TableCell>

//                             {/* Account Owner cell with red 'Not Assigned' */}
//                             <TableCell className="text-center">
//                               {client.account_assigned_name && client.account_assigned_name.trim() ? (
//                                 <Badge className="bg-green-100 text-green-800">{client.account_assigned_name}</Badge>
//                               ) : (
//                                 <Badge className="bg-red-100 text-red-800">Not Assigned</Badge>
//                               )}
//                             </TableCell>

//                             <TableCell>
//                               <div className="flex gap-2">
//                                 <Button
//                                   size="sm"
//                                   variant="outline"
//                                   onClick={() => {
//                                     setSelectedClient(client);
//                                     setHistoryDialogOpen(true);
//                                   }}
//                                   aria-label="View history"
//                                   title="View history"
//                                 >
//                                   <Eye className="h-4 w-4" />
//                                 </Button>
//                                 <Button
//                                   size="sm"
//                                   variant="outline"
//                                   onClick={() => {
//                                     setSelectedClient(client);
//                                     if (client.feedback) setFeedbackForm(client.feedback);
//                                     setFeedbackDialogOpen(true);
//                                     prevStageRef.current = client.stage;
//                                   }}
//                                   aria-label="Add feedback"
//                                   title="Add feedback"
//                                 >
//                                   <MessageSquare className="h-4 w-4" />
//                                 </Button>
//                               </div>
//                             </TableCell>
//                           </TableRow>
//                         );
//                       })}
//                     </TableBody>
//                   </Table>
//                 </div>
//               </CardContent>
//             </Card>

//             {/* HISTORY DIALOG */}
//             <Dialog open={historyDialogOpen} onOpenChange={setHistoryDialogOpen}>
//               <DialogContent className="max-w-2xl">
//                 <DialogHeader>
//                   <DialogTitle>{selectedClient?.client_name} - Full History</DialogTitle>
//                   <DialogDescription>Complete follow-up history and client interactions</DialogDescription>
//                 </DialogHeader>

//                 {selectedClient && (
//                   <div className="space-y-6">
//                     <div className="grid grid-cols-2 gap-4">
//                       <div>
//                         <Label className="text-sm font-medium">Email</Label>
//                         <p className="text-sm text-gray-600 break-words">{selectedClient.email}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Assigned To</Label>
//                         <p className="text-sm text-gray-600">{selectedClient.assigned_to}</p>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Current Stage</Label>
//                         <Badge className={getStageColor(selectedClient.stage)}>{selectedClient.stage}</Badge>
//                       </div>
//                       <div>
//                         <Label className="text-sm font-medium">Closed</Label>
//                         <p className="text-sm text-gray-600">{formatDate(selectedClient.created_at)}</p>
//                       </div>
//                     </div>

//                     <div>
//                       <Label className="text-sm font-medium mb-3 block">Follow-up History</Label>
//                       <div className="space-y-3 max-h-64 overflow-y-auto">
//                         {callHistory.length > 0 ? (
//                           callHistory.map((entry, index) => (
//                             <div key={index} className="p-3 bg-gray-50 rounded-lg">
//                               <div className="flex items-center gap-2 mb-2">
//                                 <Calendar className="h-4 w-4 text-gray-500" />
//                                 <span className="text-sm font-medium">{entry.followup_date}</span>
//                               </div>
//                               <div className="mb-2">
//                                 <span className="text-sm font-medium">Stage: </span>
//                                 <Badge className={getStageColor(entry.current_stage)}>{entry.current_stage}</Badge>
//                               </div>
//                               <p className="text-sm text-gray-600 whitespace-pre-wrap">{entry.notes}</p>
//                             </div>
//                           ))
//                         ) : (
//                           <p className="text-sm text-gray-600">No follow-up history available.</p>
//                         )}
//                       </div>
//                     </div>

//                     {clientFeedback && (
//                       <div>
//                         <Label className="text-sm font-medium mb-3 block">Latest Feedback</Label>
//                         <div className="p-3 bg-blue-50 rounded-lg space-y-2">
//                           <div className="flex items-center justify-between">
//                             <div className="flex items-center gap-2">
//                               <span className="text-sm font-medium">Rating:</span>
//                               <div className="flex">{renderStars(clientFeedback.rating)}</div>
//                             </div>
//                             <Badge variant={clientFeedback.isHappy ? "default" : "secondary"}>
//                               {clientFeedback.isHappy ? "Happy" : "Needs Attention"}
//                             </Badge>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Will Renew: </span>
//                             <span className={`text-sm ${clientFeedback.willRenew ? "text-green-600" : "text-red-600"}`}>
//                               {clientFeedback.willRenew ? "Yes" : "No"}
//                             </span>
//                           </div>
//                           <div>
//                             <span className="text-sm font-medium">Notes: </span>
//                             <p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">{clientFeedback.notes}</p>
//                           </div>
//                           <div className="text-xs text-gray-500">Feedback Date: {clientFeedback.date}</div>
//                         </div>
//                       </div>
//                     )}
//                   </div>
//                 )}
//               </DialogContent>
//             </Dialog>

//             {/* FEEDBACK DIALOG */}
//             <Dialog open={feedbackDialogOpen} onOpenChange={onFeedbackDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Client Feedback</DialogTitle>
//                   <DialogDescription>Collect feedback from {selectedClient?.client_name}</DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Is Client Happy?</Label>
//                     <Select value={feedbackForm.isHappy ? "happy" : "unhappy"} onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, isHappy: value === "happy" }))}>
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="happy">Happy</SelectItem>
//                         <SelectItem value="unhappy">Unhappy</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Rating (1-5)</Label>
//                     <Select value={String(feedbackForm.rating)} onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, rating: Number(value) }))}>
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         {[1, 2, 3, 4, 5].map((rating) => (
//                           <SelectItem key={rating} value={String(rating)}>
//                             <div className="flex items-center gap-2">
//                               <span>{rating}</span>
//                               <div className="flex">{renderStars(rating)}</div>
//                             </div>
//                           </SelectItem>
//                         ))}
//                       </SelectContent>
//                     </Select>
//                   </div>

//                   <div>
//                     <Label>Notes</Label>
//                     <Textarea placeholder="Enter detailed feedback..." value={feedbackForm.notes} onChange={(e) => setFeedbackForm((prev) => ({ ...prev, notes: e.target.value }))} />
//                   </div>

//                   <div>
//                     <Label className="text-sm font-medium mb-2 block">Will Client Renew?</Label>
//                     <Select value={feedbackForm.willRenew ? "yes" : "no"} onValueChange={(value) => setFeedbackForm((prev) => ({ ...prev, willRenew: value === "yes" }))}>
//                       <SelectTrigger>
//                         <SelectValue />
//                       </SelectTrigger>
//                       <SelectContent>
//                         <SelectItem value="yes">Yes</SelectItem>
//                         <SelectItem value="no">No</SelectItem>
//                       </SelectContent>
//                     </Select>
//                   </div>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFeedbackDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFeedbackSubmit}>Save Feedback</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* FOLLOW-UP DIALOG */}
//             <Dialog open={followUpDialogOpen} onOpenChange={onFollowUpDialogOpenChange}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Schedule Follow-up</DialogTitle>
//                 </DialogHeader>
//                 <div className="space-y-4">
//                   <div>
//                     <Label className="block mb-1">Follow-up Date</Label>
//                     <Input type="date" value={followUpForm.date} onChange={(e) => setFollowUpForm((f) => ({ ...f, date: e.target.value }))} className="w-full" />
//                   </div>
//                   <div>
//                     <Label className="block mb-1">Notes</Label>
//                     <Textarea placeholder="Add notes..." value={followUpForm.notes} onChange={(e) => setFollowUpForm((f) => ({ ...f, notes: e.target.value }))} className="w-full" />
//                   </div>
//                 </div>
//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => onFollowUpDialogOpenChange(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleFollowUpSave}>Save Follow-up</Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* CSV UPLOAD */}
//             <Dialog open={uploadDialogOpen} onOpenChange={setUploadDialogOpen}>
//               <DialogContent className="max-w-5xl">
//                 <DialogHeader>
//                   <DialogTitle>Upload Sale Done CSV</DialogTitle>
//                   <DialogDescription>
//                     Upload your sales CSV. We'll parse and show the number of entries.
//                     <br />
//                     Required columns:
//                     <br />
//                     <code>lead_id, Name, Rate, Payment Frequency, sale_done, Onboarded date, Phone number, email</code>
//                     <br />
//                     Dates must be <code>yyyy-mm-dd</code>.
//                   </DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Input
//                     type="file"
//                     accept=".csv"
//                     onChange={(e) => {
//                       const file = e.target.files?.[0];
//                       if (file) {
//                         setCsvFile(file);
//                         handleCSVUpload(file);
//                       }
//                     }}
//                   />
//                   <p className="text-sm text-gray-600">{csvData.length > 0 ? `‚úÖ Detected ${csvData.length} records in file.` : "No file parsed yet."}</p>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setUploadDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button onClick={handleCSVSubmit} disabled={csvData.length === 0}>
//                     Submit to Supabase
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>

//             {/* BULK ASSIGN DIALOG */}
//             <Dialog open={bulkDialogOpen} onOpenChange={setBulkDialogOpen}>
//               <DialogContent>
//                 <DialogHeader>
//                   <DialogTitle>Bulk Assign to Accounts Associate</DialogTitle>
//                   <DialogDescription>{selectedIds.size} selected {selectedIds.size === 1 ? "client" : "clients"}</DialogDescription>
//                 </DialogHeader>

//                 <div className="space-y-4">
//                   <Label className="text-sm font-medium">Select Accounts Associate</Label>
//                   <Select value={selectedAssociateEmail} onValueChange={(v) => setSelectedAssociateEmail(v)}>
//                     <SelectTrigger>
//                       <SelectValue placeholder="Choose associate..." />
//                     </SelectTrigger>
//                     <SelectContent>
//                       {associates.map((a) => (
//                         <SelectItem key={a.email} value={a.email}>
//                           {a.name} ‚Äî {a.email}
//                         </SelectItem>
//                       ))}
//                     </SelectContent>
//                   </Select>
//                 </div>

//                 <DialogFooter>
//                   <Button variant="outline" onClick={() => setBulkDialogOpen(false)}>
//                     Cancel
//                   </Button>
//                   <Button disabled={!selectedAssociateEmail} onClick={doBulkAssign}>
//                     Assign
//                   </Button>
//                 </DialogFooter>
//               </DialogContent>
//             </Dialog>
//           </div>
//         </DashboardLayout>
//       </ProtectedRoute>
//     </>
//   );
// }

